<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArbolApp - Biblioteca y Red Social Integrada</title>
    <link rel="stylesheet" href="style.css">
    <!-- LibrerÃ­as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="mode-library">

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="nav-bar-wood">
                <a href="index.html" class="nav-btn-wood active"><i>ğŸ“š</i> Biblioteca</a>
                <a href="social.html" class="nav-btn-wood"><i>ğŸƒ</i> Red Social</a>
                <a href="p2p.html" class="nav-btn-wood"><i>ğŸ”’</i> Chat P2P</a>
            </div>

            <div class="header-title-area" id="library-header-ui">
                <div class="center-wrapper">
                    <!-- TÃ­tulo modificado sin "Ultimate Wood" -->
                    <h1>ArbolApp</h1>
                    <div class="search-with-stars">
                        <svg class="search-star" viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 69,55 80,90 50,75 20,90 31,55 2,40 39,40" fill="gold" stroke="#B8860B" stroke-width="2" /></svg>
                        <input type="text" id="searchInput" class="search-input" placeholder="Buscar libro...">
                        <svg class="search-star" viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 69,55 80,90 50,75 20,90 31,55 2,40 39,40" fill="red" stroke="#7F1D1D" stroke-width="2" /></svg>
                    </div>
                </div>
                <!-- Guardianes -->
                <div class="guardians-container" style="position: absolute; left: 10px; bottom: -20px;">
                    <img class="guardian-shisa" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRMOuhV-r33EeG4zUxRL3zGHfM4dSlG4YDrTg&s" />
                    <img class="guardian-statue" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTxJHUlDF4_7mwDAtfC5hLyENEtVIXyFE4FDg&s" />
                </div>
                <div class="guardians-container" style="position: absolute; right: 10px; bottom: -20px;">
                    <img class="guardian-statue" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR8AyBlti_G6jkGC1lKWl3dNU1aqPrQyryoxg&s" />
                    <img class="guardian-shisa" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQyPcpMaQW_90WDRnqapKezhV8HAMJsOnbZPA&s" />
                </div>
            </div>
        </div>
    </header>

    <!-- SECCIÃ“N BIBLIOTECA -->
    <main class="library-mode">
        <div class="library-frame">
            <div class="library-inner">
                <div class="library-molding top"></div>
                <div id="bookshelvesContainer"></div>
                <div class="library-molding bottom"></div>
            </div>
        </div>
    </main>
    
    <footer>
        <p>ğŸ“š ArbolApp Biblioteca</p>
        <button onclick="libraryManager.addNewBook()" class="footer-btn">â• Agregar Libro</button>
        <button onclick="libraryManager.downloadJSON()" class="footer-btn">ğŸ’¾ Descargar JSON</button>
        <button onclick="readerManager.openTextMode()" class="footer-btn">ğŸ“ Leer Texto</button>
    </footer>

    <!-- MODAL LECTOR (CON TTS INTEGRADO) -->
    <div id="reader-modal" class="reader-modal">
        <div class="wood-panel">
            <div class="wood-panel-top-row">
                <div style="display:flex; gap:10px; align-items:center;">
                    <button onclick="readerManager.close()" style="background:none; border:none; color:inherit; cursor:pointer; font-size:1.5rem;">&times;</button>
                    <h3 id="reader-title-display">Lector de Documentos</h3>
                </div>
            </div>
            
            <!-- CONTROLES TTS ARRIBA -->
            <div class="wood-panel-controls">
                <select id="voice-select"></select>
                <button onclick="ttsManager.speak()">ğŸ”Š Leer</button>
                <button onclick="ttsManager.stop()">ğŸ›‘ Detener</button>
                <button onclick="readerManager.toggleMode()" id="mode-toggle-btn">ğŸ“ Cambiar a Texto</button>
            </div>
        </div>
        
        <div class="reader-desk">
            <div class="paper-sheet" id="reader-content-container">
                <!-- Vista PDF -->
                <iframe id="pdf-view" src=""></iframe>
                <!-- Vista Texto -->
                <textarea id="text-view" placeholder="Pega aquÃ­ el texto que quieres leer..."></textarea>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast">Mensaje</div>

    <!-- LÃ“GICA PRINCIPAL -->
    <script>
        // ===========================================
        // DATOS DE RESPALDO
        // ===========================================
        const DEFAULT_BOOKS = [
            { id: 1, title: 'Ejemplo PDF Local', author: 'Usuario', year: 2024, color: '#D2691E', pdfUrl: 'media/documentos/ejemplo.pdf' },
            { id: 2, title: 'Sutra del Diamante', author: 'Buda', year: -400, color: '#9acd32', pdfUrl: 'https://www.lastelladelmattino.org/wp-content/uploads/2010/04/El-diamante_parte-budista-completa_F.pdf' },
            { id: 3, title: 'Manual de Permacultura', author: 'FAO', year: 2018, color: '#2E8B57', pdfUrl: 'https://www.fao.org/4/ah501s/ah501s.pdf' }
        ];

        // ===========================================
        // LIBRARY MANAGER
        // ===========================================
        const libraryManager = {
            data: [],
            
            init: async () => {
                try {
                    const res = await fetch('documentos/documentos.json');
                    if (res.ok) {
                        libraryManager.data = await res.json();
                        console.log("Libros cargados desde documentos.json");
                    } else {
                        throw new Error("Error HTTP");
                    }
                } catch (e) {
                    console.warn("No se pudo cargar documentos.json, usando defaults.", e);
                    libraryManager.data = [...DEFAULT_BOOKS];
                }
                libraryManager.render();
                
                // Buscador
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = libraryManager.data.filter(b => b.title.toLowerCase().includes(term) || b.author.toLowerCase().includes(term));
                    libraryManager.render(filtered);
                });
            },

            render: (books = libraryManager.data) => {
                const container = document.getElementById('bookshelvesContainer');
                container.innerHTML = '';
                const booksPerShelf = 6;
                for (let i = 0; i < books.length; i += booksPerShelf) {
                    const shelfBooks = books.slice(i, i + booksPerShelf);
                    const shelfDiv = document.createElement('div');
                    shelfDiv.className = 'bookshelf';
                    let booksHtml = '';
                    shelfBooks.forEach(book => {
                        booksHtml += `
                            <div class="book" style="background-color: ${book.color};" onclick="readerManager.open('${book.pdfUrl}', '${book.title}')">
                                <div class="book-spine"></div>
                                <div class="book-label">
                                    <div class="book-label-text">${book.title.substring(0, 15)}...</div>
                                </div>
                            </div>
                        `;
                    });
                    shelfDiv.innerHTML = `
                        <div class="bookshelf-bg"><div class="books-container">${booksHtml}</div></div>
                        <div class="shelf-board"></div>
                    `;
                    container.appendChild(shelfDiv);
                }
            },

            addNewBook: () => {
                const title = prompt("TÃ­tulo del libro:");
                const author = prompt("Autor:");
                const url = prompt("URL o ruta (media/archivo.pdf):");
                if(title && url) {
                    libraryManager.data.push({
                        id: Date.now(), title, author, year: new Date().getFullYear(),
                        color: '#556B2F', pdfUrl: url
                    });
                    libraryManager.render();
                    showToast("Libro agregado a la sesiÃ³n local");
                }
            },

            downloadJSON: () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(libraryManager.data, null, 2));
                const node = document.createElement('a');
                node.setAttribute("href", dataStr);
                node.setAttribute("download", "documentos.json");
                document.body.appendChild(node);
                node.click();
                node.remove();
                showToast("JSON descargado.");
            }
        };

        // ===========================================
        // READER MANAGER & TTS
        // ===========================================
        const readerManager = {
            mode: 'pdf', // 'pdf' or 'text'

            open: (url, title) => {
                readerManager.setMode('pdf');
                const modal = document.getElementById('reader-modal');
                document.getElementById('reader-title-display').innerText = title || "Lector";
                
                // Cargar PDF
                const iframe = document.getElementById('pdf-view');
                if (url.startsWith('http')) {
                     iframe.src = `https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`;
                } else {
                     iframe.src = url;
                }
                
                modal.classList.add('active');
                document.body.classList.add('reading-active'); // Para CSS Responsive
            },

            openTextMode: () => {
                readerManager.setMode('text');
                document.getElementById('reader-title-display').innerText = "Lector de Texto";
                document.getElementById('reader-modal').classList.add('active');
                document.body.classList.add('reading-active');
            },

            close: () => {
                document.getElementById('reader-modal').classList.remove('active');
                document.body.classList.remove('reading-active');
                document.getElementById('pdf-view').src = ''; // Detener carga
                ttsManager.stop(); // Detener audio
            },

            toggleMode: () => {
                const newMode = readerManager.mode === 'pdf' ? 'text' : 'pdf';
                readerManager.setMode(newMode);
            },

            setMode: (mode) => {
                readerManager.mode = mode;
                const container = document.getElementById('reader-content-container');
                const btn = document.getElementById('mode-toggle-btn');
                
                if (mode === 'pdf') {
                    container.className = 'paper-sheet reader-mode-pdf';
                    btn.innerText = "ğŸ“ Cambiar a Texto";
                } else {
                    container.className = 'paper-sheet reader-mode-text';
                    btn.innerText = "ğŸ“„ Cambiar a PDF";
                }
            }
        };

        const ttsManager = {
            synth: window.speechSynthesis,
            voices: [],

            init: () => {
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = ttsManager.loadVoices;
                }
                ttsManager.loadVoices();
            },

            loadVoices: () => {
                ttsManager.voices = ttsManager.synth.getVoices();
                const select = document.getElementById('voice-select');
                select.innerHTML = '';
                
                // Filtrar voces femeninas (HeurÃ­stica basada en nombre comÃºn)
                const femaleVoices = ttsManager.voices.filter(v => 
                    v.name.includes('Female') || 
                    v.name.includes('Google') || 
                    v.name.includes('Samantha') || 
                    v.name.includes('Zira') ||
                    v.name.includes('Victoria') ||
                    v.name.includes('Jorge') == false // ExclusiÃ³n bÃ¡sica
                );

                // Si no hay suficientes voces "femeninas" detectadas, usar todas
                const voicesToUse = femaleVoices.length > 0 ? femaleVoices : ttsManager.voices;

                voicesToUse.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.setAttribute('data-lang', voice.lang);
                    option.setAttribute('data-name', voice.name);
                    select.appendChild(option);
                });
            },

            speak: () => {
                if (ttsManager.synth.speaking) {
                    console.error('Ya se estÃ¡ leyendo');
                    return;
                }

                let text = "";
                if (readerManager.mode === 'text') {
                    text = document.getElementById('text-view').value;
                } else {
                    // Si estÃ¡ en modo PDF, no podemos leer el contenido del iframe directamente por seguridad (CORS).
                    // Avisamos al usuario que cambie a modo texto.
                    showToast("Para leer PDF, copia el texto y usa el modo Texto.");
                    return; 
                }

                if (text !== '') {
                    const utterThis = new SpeechSynthesisUtterance(text);
                    const select = document.getElementById('voice-select');
                    const selectedOption = select.selectedOptions[0].getAttribute('data-name');
                    
                    const voice = ttsManager.voices.find(v => v.name === selectedOption);
                    if(voice) utterThis.voice = voice;

                    utterThis.onend = function (event) {
                        console.log('Lectura terminada');
                    };
                    utterThis.onerror = function (event) {
                        console.error('Error en TTS');
                    };
                    ttsManager.synth.speak(utterThis);
                } else {
                    showToast("No hay texto para leer.");
                }
            },

            stop: () => {
                ttsManager.synth.cancel();
            }
        };

        // ===========================================
        // UTILIDADES
        // ===========================================
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // ===========================================
        // INICIALIZACIÃ“N
        // ===========================================
        window.addEventListener('DOMContentLoaded', () => {
            libraryManager.init();
            ttsManager.init();
        });

    </script>
</body>
</html>
