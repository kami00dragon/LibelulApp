<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArbolApp - Biblioteca</title>
    <link rel="stylesheet" href="style.css">
    <!-- Librer√≠as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="mode-library">

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="nav-bar-wood">
                <a href="index.html" class="nav-btn-wood active"><i>üìö</i> Biblioteca</a>
                <a href="social.html" class="nav-btn-wood"><i>üçÉ</i> Red Social</a>
                <a href="p2p.html" class="nav-btn-wood"><i>üîí</i> Chat P2P</a>
            </div>

            <div class="header-title-area" id="library-header-ui">
                <div class="center-wrapper">
                    <h1>ArbolApp</h1>
                    <div class="search-with-stars">
                        <svg class="search-star" viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 69,55 80,90 50,75 20,90 31,55 2,40 39,40" fill="gold" stroke="#B8860B" stroke-width="2" /></svg>
                        <input type="text" id="searchInput" class="search-input" placeholder="Buscar libro...">
                        <svg class="search-star" viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 69,55 80,90 50,75 20,90 31,55 2,40 39,40" fill="red" stroke="#7F1D1D" stroke-width="2" /></svg>
                    </div>
                </div>
                <!-- Guardianes -->
                <div class="guardians-container" style="position: absolute; left: 10px; bottom: -20px;">
                    <img class="guardian-shisa" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRMOuhV-r33EeG4zUxRL3zGHfM4dSlG4YDrTg&s" />
                    <img class="guardian-statue" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTxJHUlDF4_7mwDAtfC5hLyENEtVIXyFE4FDg&s" />
                </div>
                <div class="guardians-container" style="position: absolute; right: 10px; bottom: -20px;">
                    <img class="guardian-statue" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR8AyBlti_G6jkGC1lKWl3dNU1aqPrQyryoxg&s" />
                    <img class="guardian-shisa" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQyPcpMaQW_90WDRnqapKezhV8HAMJsOnbZPA&s" />
                </div>
            </div>
        </div>
    </header>

    <!-- SECCI√ìN BIBLIOTECA -->
    <main class="library-mode">
        <div class="library-frame">
            <div class="library-inner">
                <div class="library-molding top"></div>
                <div id="bookshelvesContainer"></div>
                <div class="library-molding bottom"></div>
            </div>
        </div>
    </main>
    
    <footer>
        <p>üìö ArbolApp Biblioteca</p>
        <button onclick="libraryManager.addNewBook()" class="footer-btn">‚ûï Agregar Libro</button>
        <button onclick="libraryManager.downloadJSON()" class="footer-btn">üíæ Descargar JSON</button>
        <button onclick="readerManager.openTextMode()" class="footer-btn">üìù Leer Texto</button>
    </footer>

    <!-- MODAL LECTOR -->
    <div id="reader-modal" class="reader-modal">
        <div class="wood-panel">
            <div class="wood-panel-top-row">
                <div style="display:flex; gap:10px; align-items:center;">
                    <button onclick="readerManager.close()" style="background:none; border:none; color:inherit; cursor:pointer; font-size:1.5rem;">&times;</button>
                    <h3 id="reader-title-display">Lector de Documentos</h3>
                </div>
            </div>
            
            <!-- CONTROLES TTS ARRIBA -->
            <div class="wood-panel-controls">
                <select id="voice-select"></select>
                <button onclick="ttsManager.speak()">üîä Leer</button>
                <button onclick="ttsManager.stop()">üõë Detener</button>
                <button onclick="readerManager.toggleMode()" id="mode-toggle-btn">üìù Cambiar a Texto</button>
            </div>
        </div>
        
        <div class="reader-desk">
            <div class="paper-sheet" id="reader-content-container">
                <iframe id="pdf-view" src=""></iframe>
                <textarea id="text-view" placeholder="Pega aqu√≠ el texto que quieres leer..."></textarea>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast">Mensaje</div>

    <!-- L√ìGICA PRINCIPAL -->
    <script>
        // ===========================================
        // BASE DE DATOS DE LIBROS (CARGADA INTERNA)
        // ===========================================
        
        // 1. LAS TRES ENCICLOPEDIAS (AL PRINCIPIO)
        const ENCYCLOPEDIAS = [
            { id: 'enc-1', title: 'Gran Enciclopedia de la Naturaleza', author: 'Varios Autores', year: 2024, color: '#5D4037', pdfUrl: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf' },
            { id: 'enc-2', title: 'Enciclopedia de la Historia Universal', author: 'Academia de Historia', year: 2023, color: '#795548', pdfUrl: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf' },
            { id: 'enc-3', title: 'Enciclopedia de las Ciencias', author: 'Instituto Cient√≠fico', year: 2024, color: '#8D6E63', pdfUrl: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf' }
        ];

        // 2. EL RESTO DE LOS LIBROS (M√ÅS DE 200)
        // Generamos libros de ejemplo para cumplir con el requisito de "m√°s de 200".
        // NOTA: Si tienes tus propios libros, borra este bucle y pega tu array aqu√≠.
        const OTHER_BOOKS = [];
        const bookColors = ['#A1887F', '#BCAAA4', '#8D6E63', '#6D4C41', '#5D4037', '#4E342E', '#3E2723', '#00695C', '#2E7D32', '#33691E'];
        
        for (let i = 1; i <= 215; i++) {
            OTHER_BOOKS.push({
                id: `book-${i}`,
                title: `Tomo ${i} del Saber Antiguo`,
                author: `Autor An√≥nimo ${i}`,
                year: 1900 + (i % 124),
                color: bookColors[i % bookColors.length],
                pdfUrl: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf' // Enlace dummy para ejemplo
            });
        }

        // UNIFICAR LISTA FINAL (Enciclopedias primero, luego el resto)
        const LIBRARY_DATA = [...ENCYCLOPEDIAS, ...OTHER_BOOKS];


        // ===========================================
        // LIBRARY MANAGER
        // ===========================================
        const libraryManager = {
            data: [],
            
            init: () => {
                // MODIFICACI√ìN: Ya no hacemos fetch. Cargamos directamente los datos internos.
                libraryManager.data = LIBRARY_DATA;
                
                console.log(`Cargados ${libraryManager.data.length} libros internos.`);
                
                libraryManager.render();
                
                // Buscador
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = libraryManager.data.filter(b => 
                        b.title.toLowerCase().includes(term) || 
                        b.author.toLowerCase().includes(term)
                    );
                    libraryManager.render(filtered);
                });
            },

            render: (books = libraryManager.data) => {
                const container = document.getElementById('bookshelvesContainer');
                container.innerHTML = '';
                
                // Renderizamos los libros en estantes de a 6 para que se vean ordenados
                const booksPerShelf = 6;
                
                for (let i = 0; i < books.length; i += booksPerShelf) {
                    const shelfBooks = books.slice(i, i + booksPerShelf);
                    const shelfDiv = document.createElement('div');
                    shelfDiv.className = 'bookshelf';
                    
                    let booksHtml = '';
                    shelfBooks.forEach(book => {
                        // Truncamos el t√≠tulo si es muy largo para el lomo del libro
                        let displayTitle = book.title.length > 15 ? book.title.substring(0, 12) + '...' : book.title;
                        
                        booksHtml += `
                            <div class="book" style="background-color: ${book.color};" onclick="readerManager.open('${book.pdfUrl}', '${book.title}')">
                                <div class="book-spine"></div>
                                <div class="book-label">
                                    <div class="book-label-text">${displayTitle}</div>
                                </div>
                            </div>
                        `;
                    });

                    shelfDiv.innerHTML = `
                        <div class="bookshelf-bg"><div class="books-container">${booksHtml}</div></div>
                        <div class="shelf-board"></div>
                    `;
                    container.appendChild(shelfDiv);
                }
            },

            addNewBook: () => {
                const title = prompt("T√≠tulo del libro:");
                const author = prompt("Autor:");
                const url = prompt("URL o ruta (media/archivo.pdf):");
                if(title && url) {
                    const newBook = {
                        id: 'custom-' + Date.now(),
                        title, 
                        author, 
                        year: new Date().getFullYear(),
                        color: '#556B2F', 
                        pdfUrl: url
                    };
                    // Agregamos al inicio para que se vea de inmediato (despu√©s de las enciclopedias si quisi√©ramos, pero por defecto al principio del array)
                    // Para mantener las enciclopedias al principio, lo ideal es insertar despu√©s del √≠ndice 2, 
                    // pero el usuario pidi√≥ agregar libro, as√≠ que lo pondremos al principio de la lista visual o al final.
                    // Lo pondremos al principio del array data (desplazando las enciclopedias si no estamos cuidadosos, 
                    // pero como renderizamos `data` entero, lo insertaremos al inicio del array `libraryManager.data`).
                    
                    libraryManager.data.unshift(newBook); // Pone el nuevo libro al principio de TODO
                    
                    // Si queremos forzar que las 3 enciclopedias sigan siendo las 3 primeras:
                    // 1. Extraemos enciclopedias
                    const encs = libraryManager.data.filter(b => b.title.includes("Enciclopedia"));
                    // 2. Extraemos el resto
                    const others = libraryManager.data.filter(b => !b.title.includes("Enciclopedia"));
                    // 3. Reordenamos
                    libraryManager.data = [...encs, ...others];

                    libraryManager.render();
                    showToast("Libro agregado a la sesi√≥n local");
                }
            },

            downloadJSON: () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(libraryManager.data, null, 2));
                const node = document.createElement('a');
                node.setAttribute("href", dataStr);
                node.setAttribute("download", "documentos_backup.json");
                document.body.appendChild(node);
                node.click();
                node.remove();
                showToast("JSON descargado.");
            }
        };

        // ===========================================
        // READER MANAGER & TTS
        // ===========================================
        const readerManager = {
            mode: 'pdf', 

            open: (url, title) => {
                readerManager.setMode('pdf');
                const modal = document.getElementById('reader-modal');
                document.getElementById('reader-title-display').innerText = title || "Lector";
                const iframe = document.getElementById('pdf-view');
                
                // Si es un enlace dummy de ejemplo o no existe, mostramos un mensaje
                if (url.includes('dummy.pdf') || !url) {
                   // iframe.src = "about:blank"; 
                   // No hacemos nada, deja que cargue el dummy o el error nativo del iframe
                }

                if (url.startsWith('http')) {
                     iframe.src = `https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(url)}`;
                } else {
                     iframe.src = url;
                }
                
                modal.classList.add('active');
                document.body.classList.add('reading-active');
            },

            openTextMode: () => {
                readerManager.setMode('text');
                document.getElementById('reader-title-display').innerText = "Lector de Texto";
                document.getElementById('reader-modal').classList.add('active');
                document.body.classList.add('reading-active');
            },

            close: () => {
                document.getElementById('reader-modal').classList.remove('active');
                document.body.classList.remove('reading-active');
                document.getElementById('pdf-view').src = ''; 
                ttsManager.stop();
            },

            toggleMode: () => {
                const newMode = readerManager.mode === 'pdf' ? 'text' : 'pdf';
                readerManager.setMode(newMode);
            },

            setMode: (mode) => {
                readerManager.mode = mode;
                const container = document.getElementById('reader-content-container');
                const btn = document.getElementById('mode-toggle-btn');
                
                if (mode === 'pdf') {
                    container.className = 'paper-sheet reader-mode-pdf';
                    btn.innerText = "üìù Cambiar a Texto";
                } else {
                    container.className = 'paper-sheet reader-mode-text';
                    btn.innerText = "üìÑ Cambiar a PDF";
                }
            }
        };

        const ttsManager = {
            synth: window.speechSynthesis,
            voices: [],

            init: () => {
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = ttsManager.loadVoices;
                }
                ttsManager.loadVoices();
            },

            loadVoices: () => {
                ttsManager.voices = ttsManager.synth.getVoices();
                const select = document.getElementById('voice-select');
                select.innerHTML = '';
                
                const femaleVoices = ttsManager.voices.filter(v => 
                    v.name.includes('Female') || 
                    v.name.includes('Google') || 
                    v.name.includes('Samantha') || 
                    v.name.includes('Zira') ||
                    v.name.includes('Victoria') ||
                    v.name.includes('Jorge') == false
                );

                const voicesToUse = femaleVoices.length > 0 ? femaleVoices : ttsManager.voices;

                voicesToUse.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.setAttribute('data-lang', voice.lang);
                    option.setAttribute('data-name', voice.name);
                    select.appendChild(option);
                });
            },

            speak: () => {
                if (ttsManager.synth.speaking) {
                    console.error('Ya se est√° leyendo');
                    return;
                }

                let text = "";
                if (readerManager.mode === 'text') {
                    text = document.getElementById('text-view').value;
                } else {
                    showToast("Para leer PDF, copia el texto y usa el modo Texto.");
                    return; 
                }

                if (text !== '') {
                    const utterThis = new SpeechSynthesisUtterance(text);
                    const select = document.getElementById('voice-select');
                    const selectedOption = select.selectedOptions[0].getAttribute('data-name');
                    
                    const voice = ttsManager.voices.find(v => v.name === selectedOption);
                    if(voice) utterThis.voice = voice;

                    utterThis.onend = function (event) { console.log('Lectura terminada'); };
                    utterThis.onerror = function (event) { console.error('Error en TTS'); };
                    ttsManager.synth.speak(utterThis);
                } else {
                    showToast("No hay texto para leer.");
                }
            },

            stop: () => {
                ttsManager.synth.cancel();
            }
        };

        // ===========================================
        // UTILIDADES
        // ===========================================
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // ===========================================
        // INICIALIZACI√ìN
        // ===========================================
        window.addEventListener('DOMContentLoaded', () => {
            libraryManager.init();
            ttsManager.init();
        });

    </script>
</body>
</html>
