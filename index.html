<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibelulApp - Ultimate Wood Edition</title>
    <!-- Librer√≠as para generaci√≥n de PDF e Im√°genes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Librer√≠a P2P -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
   
    <style>
        /* =========================================
           CSS UNIFICADO (ULTIMATE WOOD THEME + SOCIAL)
           ========================================= */
        :root {
            --wood-dark: #451a03;
            --wood-light: #78350f;
            --leaf-green: #2e7d32;
            --leaf-light: #66bb6a;
            --flower-pink: #e91e63;
            --text-parchment: #efebe9;
            --border-stem: #1b5e20;
            --sidebar-width: 340px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
       
        body {
            font-family: 'Georgia', serif;
            min-height: 100vh;
            background: linear-gradient(to bottom, #fef3c7, #fcd34d);
            color: var(--text-parchment);
            overflow-x: hidden;
            transition: background 0.3s ease;
        }

        /* MODO LIBRER√çA */
        body.mode-library { overflow-y: auto; }

        /* MODO SOCIAL (CORREGIDO PARA CRECIMIENTO INFINITO) */
        body.mode-social {
            overflow-y: auto; /* Permitir scroll en el body */
            background: var(--wood-dark);
            background-image: repeating-linear-gradient(45deg, #3e2723 0, #3e2723 10px, #4e342e 10px, #4e342e 20px);
            color: var(--text-parchment);
            /* Altura m√≠nima para que cubra la pantalla, pero auto para crecer */
            min-height: 100vh; 
        }

        /* --- HEADER & NAV --- */
        header {
            background: linear-gradient(to bottom, var(--wood-dark), var(--wood-light), var(--wood-dark));
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            padding: 1rem 1rem 0 1rem;
            position: relative; width: 100%; z-index: 50;
            border-bottom: 4px solid #281a16;
            display: flex; flex-direction: column; align-items: center;
            flex-shrink: 0;
        }

        .header-content { max-width: 1600px; margin: 0 auto; width: 100%; }

        .nav-bar-wood {
            display: flex; justify-content: center; gap: 10px; margin-bottom: 1rem; flex-wrap: wrap;
        }
        .nav-btn-wood {
            background: linear-gradient(to bottom, #6d4c41, #4e342e);
            border: 2px solid #3e2723;
            color: #fcd34d;
            padding: 10px 20px;
            font-family: 'Georgia', serif; font-weight: bold; font-size: 1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            cursor: pointer;
            border-radius: 4px;
            box-shadow: 0 4px 0 #281a16, 0 5px 10px rgba(0,0,0,0.3);
            transition: all 0.1s;
            display: flex; align-items: center; gap: 8px;
        }
        .nav-btn-wood:active { transform: translateY(4px); box-shadow: 0 0 0 #281a16; }
        .nav-btn-wood:hover { background: linear-gradient(to bottom, #7d5c51, #5e443e); color: #fff; border-color: #fcd34d; }
        .nav-btn-wood.active { background: linear-gradient(to bottom, #fcd34d, #f59e0b); color: #3e2723; text-shadow: none; border-color: #fff; box-shadow: 0 4px 0 #b45309; }

        .header-title-area { display: flex; align-items: flex-end; justify-content: space-between; width: 100%; margin-bottom: 0.5rem; position: relative; }
        .header-title h1 {
            font-size: 2.5rem; font-weight: 900; font-family: 'Georgia', serif;
            color: #fcd34d; letter-spacing: 2px; margin: 0; text-align: center; width: 100%;
            text-shadow: 2px 2px 0px #281a16;
        }
        .center-wrapper { max-width: 600px; width: 100%; text-align: center; position: relative; margin: 0 auto 1rem auto; z-index: 5; }
        .search-with-stars { display: flex; align-items: center; gap: 0.75rem; width: 100%; margin: 0 auto; }
        .search-star { width: 2.5rem; height: 2.5rem; filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3)); flex-shrink: 0; }
        .search-input {
            padding: 0.75rem 1rem; border-radius: 0.5rem; border: 2px solid #f59e0b;
            background: white; color: #78350f; font-size: 1rem; width: 100%;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .guardians-container { display: flex; align-items: flex-end; gap: 0; position: relative; z-index: 2; }
        .guardian-shisa { width: 9rem; height: 10.5rem; filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.4)); }
        .guardian-statue { width: 7.5rem; height: 10.5rem; filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.4)); }
       
        @media (min-width: 768px) {
            .guardian-statue { width: 9rem; height: 12rem; }
            .guardian-shisa { width: 11rem; height: 12rem; }
        }

        /* --- SECTIONS --- */
        .app-section { display: none; width: 100%; }
        .app-section.active { display: block; }

        /* =========================================
           CSS BIBLIOTECA (HEREDADO Y UNIFICADO)
           ========================================= */
        main.library-mode { flex: 1; max-width: 1400px; margin: 0 auto; padding: 2rem 1rem; width: 100%; position: relative; }
        .library-frame { position: relative; background: linear-gradient(to bottom, var(--wood-light), var(--wood-dark)); border-radius: 1rem; padding: 1rem; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); width: 100%; border: 2px solid #4e342e; }
        .library-inner { position: relative; background: linear-gradient(to bottom, #5d4037, #4e342e); border-radius: 0.75rem; padding: 1.5rem; box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.2); width: 100%; border: 1px solid #3e2723; }
        .library-molding { position: absolute; left: 0; right: 0; height: 1rem; background: linear-gradient(to bottom, #6d4c41, #5d4037); }
        .library-molding.top { top: 0; border-radius: 0.75rem 0.75rem 0 0; }
        .library-molding.bottom { bottom: 0; border-radius: 0 0 0.75rem 0.75rem; }
       
        .bookshelf { margin-bottom: 1.5rem; }
        .bookshelf-bg { background: transparent; border-radius: 0.5rem; padding: 1.5rem; min-height: 200px; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3); position: relative; overflow: hidden; }
        .books-container { display: flex; align-items: flex-end; justify-content: center; gap: 0.25rem; min-height: 160px; padding-bottom: 0.75rem; flex-wrap: wrap; }
        .books-container.align-left { justify-content: flex-start; padding-left: 0.5rem; }
        .books-container.align-right { justify-content: flex-end; padding-right: 0.5rem; }
        .shelf-board { height: 1.5rem; background: linear-gradient(to bottom, #6d4c41, #4e342e); border-radius: 0.125rem; box-shadow: 0 6px 10px rgba(0, 0, 0, 0.6); border-top: 1px solid rgba(255,255,255,0.1); position: relative; z-index: 1; }
       
        .book { position: relative; width: 2.5rem; height: 10rem; border-radius: 0.125rem; background: #8B4513; box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4), inset 1px 1px 2px rgba(255, 255, 255, 0.1); transform: translateY(0); transition: all 0.3s ease; cursor: pointer; overflow: hidden; z-index: 5; border: none; }
        .book:hover { transform: translateY(-4px) scale(1.05); box-shadow: 4px 4px 12px rgba(0, 0, 0, 0.5); }
        .book-spine { position: absolute; left: 0; top: 0; bottom: 0; width: 0.5rem; background: rgba(0, 0, 0, 0.2); }
        .book-texture { position: absolute; inset: 0; background: linear-gradient(to right, rgba(0, 0, 0, 0.3), transparent); }
        .book-decoration { position: absolute; left: 0.125rem; top: 0.5rem; bottom: 0.5rem; display: flex; flex-direction: column; justify-content: space-between; }
        .book-line { width: 0.25rem; height: 0.125rem; background: rgba(255, 255, 255, 0.2); }
        .book-label { position: absolute; right: 0.25rem; top: 50%; transform: translateY(-50%); width: 1.25rem; }
        .book-label-text { font-size: 0.5rem; color: rgba(255, 255, 255, 0.8); font-weight: bold; line-height: 1.2; }
        .book-label-author { font-size: 0.4rem; color: rgba(255, 255, 255, 0.6); margin-top: 0.125rem; }

        .special-book { position: relative; width: 4rem; height: 10rem; border-radius: 0.125rem; background: #8B4513; cursor: pointer; z-index: 5; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-decoration: none; box-shadow: 2px 2px 8px rgba(0,0,0,0.4); overflow: visible; }
        .special-book:hover { transform: translateY(-4px) scale(1.05); box-shadow: 4px 4px 12px rgba(0, 0, 0, 0.5); }
        .special-book-texture { position: absolute; inset: 0; background: linear-gradient(to right, rgba(0, 0, 0, 0.3), transparent); }
        .special-book-decoration { position: absolute; left: 0.25rem; top: 0.5rem; bottom: 0.5rem; display: flex; flex-direction: column; justify-content: space-between; }
        .special-book-line { width: 0.25rem; height: 0.125rem; background: rgba(255, 255, 255, 0.2); }
        .special-book-label { position: absolute; right: 0.5rem; top: 15%; transform: rotate(-180deg); font-size: 0.75rem; color: white; font-weight: bold; letter-spacing: 0.1em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8); line-height: 1.2; writing-mode: vertical-rl; text-orientation: mixed; height: 70%; overflow: hidden; }

        /* Insectos */
        .butterfly { position: absolute; top: 10px; right: -5px; width: 24px; height: 20px; z-index: 20; pointer-events: none; }
        .butterfly-wing { position: absolute; top: 0; width: 12px; height: 18px; background: rgba(147, 51, 234, 0.7); border-radius: 50% 50% 0 50%; animation: flutter 0.15s infinite alternate; }
        .butterfly.blue .butterfly-wing { background: rgba(59, 130, 246, 0.7); }
        .butterfly.yellow .butterfly-wing { background: rgba(234, 179, 8, 0.7); }
        .butterfly-wing.left { left: 0; transform-origin: right center; }
        .butterfly-wing.right { right: 0; transform-origin: left center; transform: scaleX(-1); }
        @keyframes flutter { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(60deg); } }

        .ladybug-container { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 16px; height: 14px; z-index: 20; transform-style: preserve-3d; perspective: 50px; }
        .ladybug-head { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 10px; height: 5px; background: black; border-radius: 5px; z-index: 30; }
        .ladybug-wing-under { position: absolute; top: 2px; bottom: 2px; width: 40%; background: rgba(0, 0, 0, 0.5); border-radius: 50%; z-index: 10; animation: flutterWings 0.1s infinite alternate; }
        .ladybug-wing-under.left { left: 10%; transform-origin: right center; }
        .ladybug-wing-under.right { right: 10%; transform-origin: left center; }
        @keyframes flutterWings { 0% { transform: rotateY(-10deg); } 100% { transform: rotateY(10deg); } }
        .ladybug-shell { position: absolute; top: 0; bottom: 0; width: 50%; background: radial-gradient(circle at 30% 30%, #ef4444, #b91c1c); z-index: 20; animation: openShell 1.5s infinite ease-in-out alternate; }
        .ladybug-shell.left { left: 0; border-radius: 8px 0 0 0; transform-origin: right center; }
        .ladybug-shell.right { right: 0; border-radius: 0 8px 0 0; transform-origin: left center; }
        .ladybug-spot-shell { position: absolute; width: 2px; height: 2px; background: black; border-radius: 50%; }
        .ls-1 { top: 2px; right: 2px; } .ls-2 { top: 5px; right: 4px; }
        .ls-3 { top: 2px; left: 2px; } .ls-4 { top: 5px; left: 4px; }
        @keyframes openShell { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(-70deg); } }

        .ladybug-walking { position: absolute; width: 8px; height: 8px; background: radial-gradient(circle at 30% 30%, #ef4444, #b91c1c); border-radius: 50%; z-index: 4; box-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .ladybug-walking::before { content: ''; position: absolute; top: -2px; left: 1px; width: 5px; height: 3px; background: black; border-radius: 50%; }
        .ladybug-walking::after { content: ''; position: absolute; top: 0; left: 50%; height: 100%; width: 1px; background: black; }
        .ladybug-walking .spot { position: absolute; width: 1.5px; height: 1.5px; background: black; border-radius: 50%; }
        .lw-s1 { top: 1px; left: 1px; } .lw-s2 { top: 5px; left: 1px; }
        .lw-s3 { top: 1px; right: 1px; } .lw-s4 { top: 5px; right: 1px; }
        .ladybug-walking-legs { position: absolute; bottom: -1px; left: -1px; width: 10px; height: 2px; background: transparent; }
        .ladybug-walking-legs::before, .ladybug-walking-legs::after { content: ''; position: absolute; width: 3px; height: 2px; background: black; border-radius: 2px; }
        .ladybug-walking-legs::before { left: 1px; animation: leg-move 0.2s infinite; }
        .ladybug-walking-legs::after { right: 1px; animation: leg-move 0.2s infinite reverse; }
        @keyframes leg-move { 0% { transform: rotate(0deg); } 100% { transform: rotate(20deg); } }

        /* Gatos y Zorro */
        .cat-container { position: fixed; left: -300px; bottom: 2rem; width: 150px; height: 110px; z-index: 1000; pointer-events: auto; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3)); will-change: transform, left; cursor: pointer; }
        .cat-container.small-cat { width: 120px; height: 88px; }
        .facing-left { transform: scaleX(-1); } .facing-right { transform: scaleX(1); }
        .cat-svg { width: 100%; height: 100%; overflow: visible; }
        .cat-body { fill: #fffbf0; } .cat-head { fill: #fffbf0; }
        .patch-black { fill: #2c3e50; } .patch-orange { fill: #e67e22; }
        .cat-eye { fill: #f1c40f; stroke: #2c3e50; stroke-width: 1; }
        .cat-pupil { fill: #000; transform-box: fill-box; transform-origin: center; }
        .eyelid { fill: #2c3e50; opacity: 0; transform-box: fill-box; transform-origin: center; }
        .cat-nose { fill: pink; }
        .cat-tail { fill: none; stroke: #2c3e50; stroke-width: 8; stroke-linecap: round; }
        .cat-paw { fill: #fffbf0; stroke: #e0e0e0; stroke-width: 1; transform-origin: top center; }
        @keyframes blinkAnim { 0%, 94%, 100% { opacity: 0; transform: scaleY(1); } 97% { opacity: 1; transform: scaleY(0.1); } }
        .cat-eye .eyelid { animation: blinkAnim 5s infinite; }
        .cat-paw.swiping { animation: swipeAnim 0.2s ease-out; }
        @keyframes swipeAnim { 0% { transform: rotate(0deg); } 50% { transform: rotate(-45deg) translateX(-10px); } 100% { transform: rotate(0deg); } }

        .baby-fox { position: fixed; width: 130px; height: 95px; z-index: 1001; pointer-events: none; filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3)); }

        footer { background: linear-gradient(to right, var(--wood-light), #92400e, var(--wood-light)); box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.3); padding: 1.5rem; margin-bottom: 50px; border-top: 4px solid #281a16; text-align: center; }
        .footer-btn { background: var(--wood-light); color: #fcd34d; border: 2px solid #281a16; padding: 10px 20px; border-radius: 0.5rem; font-family: 'Georgia', serif; cursor: pointer; margin: 0 5px; }
        .footer-btn:hover { background: #5d4037; }

        /* =========================================
           CSS RED SOCIAL (ARBOLAPP - INFINITO)
           ========================================= */
        .app-layout { 
            display: grid; 
            grid-template-columns: var(--sidebar-width) 1fr; 
            /* FIX: Usamos min-height para que cubra la pantalla pero height auto para crecer */
            min-height: calc(100vh - 210px); 
            height: auto; 
            max-width: 1600px; 
            margin: 0 auto; 
            background-color: rgba(0,0,0,0.2); 
            position: relative; 
        }
        
        .sidebar { 
            background-color: var(--wood-light); 
            border-right: 5px solid var(--leaf-green); 
            display: flex; 
            flex-direction: column; 
            /* El sidebar tambi√©n crecer√° con el contenido */
            min-height: 100%; 
            z-index: 20; 
        }
        
        .sidebar-header { background-color: var(--leaf-green); padding: 20px; text-align: center; border-bottom: 4px solid var(--flower-pink); }
        .sidebar-header h2 { margin: 0; font-size: 1.2rem; color: white; }
        .sidebar-tabs { display: flex; background: #1b5e20; }
        .tab-btn { flex: 1; background: none; border: none; color: #a5d6a7; padding: 15px 0; cursor: pointer; font-weight: bold; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { background: var(--wood-light); color: var(--text-parchment); border-bottom-color: var(--flower-pink); }
        .sidebar-content { padding: 20px; overflow-y: auto; flex-grow: 1; }
       
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #ffcc80; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; background: #3e2723; border: 1px solid #795548; color: #efebe9; border-radius: 4px; font-family: inherit; box-sizing: border-box; }
        .btn-action { width: 100%; padding: 12px; background: var(--flower-pink); color: white; border: none; border-radius: 5px; font-size: 1rem; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: background 0.2s; }
        .btn-action:hover { background: #c2185b; }
        .btn-secondary { width: 100%; padding: 10px; background: #5d4037; color: white; border: 1px solid #8d6e63; border-radius: 5px; cursor: pointer; }
        .btn-secondary:hover { background: #4e342e; }

        /* FEED PRINCIPAL */
        .main-feed { 
            background-color: rgba(62, 39, 35, 0.95); 
            overflow: visible; /* El scroll lo maneja el body ahora */
            min-height: 100%; 
            border-left: 8px solid var(--wood-dark); 
            position: relative; 
        }
        
        .tree-trunk { 
            max-width: 700px; 
            margin: 0 auto; 
            min-height: 100%; 
            border-left: 8px solid var(--leaf-green); 
            border-right: 8px solid var(--leaf-green); 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            padding-bottom: 40px;
        }
        
        .feed-header { 
            background-color: var(--leaf-green); 
            padding: 15px 20px; 
            text-align: center; 
            border-bottom: 5px solid var(--leaf-light); 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .nav-branches { display: flex; justify-content: center; background: #2e7d32; }
        .nav-btn { background: none; border: none; color: white; padding: 15px 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border-bottom: 4px solid transparent; transition: all 0.3s; }
        .nav-btn.active { border-bottom-color: var(--flower-pink); background-color: rgba(0,0,0,0.1); }
       
        .leaf-card { background-color: var(--wood-light); border-radius: 5px 30px 5px 30px; padding: 20px; margin: 20px; border: 2px solid var(--border-stem); position: relative; box-shadow: 5px 5px 0px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .leaf-card:hover { transform: translateY(-3px); }
        .leaf-card::before { content: 'üåø'; position: absolute; top: -15px; left: -10px; font-size: 1.5rem; transform: rotate(-20deg); }
        .post-meta { font-size: 0.8rem; color: #a5d6a7; margin-bottom: 10px; border-bottom: 1px dashed #795548; padding-bottom: 5px; display: flex; justify-content: space-between; }
        .post-title { font-size: 1.5rem; margin: 0 0 10px 0; color: #ffcc80; }
        .post-content { line-height: 1.6; font-size: 1rem; white-space: pre-wrap; word-wrap: break-word; }
        .media-container { margin-top: 15px; border-radius: 10px; overflow: hidden; border: 3px solid #3e27d3; background: #000; max-height: 400px; display: flex; justify-content: center; }
        .media-container img, .media-container video { max-width: 100%; max-height: 100%; object-fit: contain; }
        .download-link { display: inline-block; margin-top: 10px; padding: 5px 15px; background: var(--flower-pink); color: white; text-decoration: none; border-radius: 15px; font-size: 0.9rem; }
       
        .source-manager { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #5d4037; }
        .source-manager h4 { margin-top: 0; color: var(--flower-pink); font-size: 0.9rem; }
        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .input-group input { flex: 1; }
        .loading-frog { text-align: center; padding: 20px; font-size: 3rem; }

        /* FIX: RESPONSIVE MOBILE (Desde ArbolApp Original) */
        @media (max-width: 900px) {
            .app-layout { 
                grid-template-columns: 1fr; 
                height: auto; 
                overflow-y: visible; 
            }
            .sidebar { 
                height: auto; 
                max-height: none;
            }
            body.mode-social { overflow: auto; height: auto; } 
            .main-feed { 
                height: auto; 
                overflow: visible; 
                border-left: none;
            }
            .tree-trunk { border: none; box-shadow: none; }
            
            .header-title h1 { font-size: 1.5rem; }
            .guardians-container { display: none; }
            .search-star { width: 1.5rem; height: 1.5rem; }
        }

        /* =========================================
           CSS DEL LECTOR MATERIAL (ULTIMATE WOOD)
           ========================================= */
        .reader-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a;
            z-index: 3000;
            flex-direction: column;
        }
        .reader-modal.active { display: flex; }

        .wood-panel {
            background: linear-gradient(to bottom, #451a03, #78350f, #451a03);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255,255,255,0.1);
            border-bottom: 4px solid #281a16;
            border-top: 1px solid #5d4037;
            position: relative;
            z-index: 100;
        }
        .wood-panel::after {
            content: "";
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: repeating-linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03) 1px, transparent 2px, transparent 10px);
            pointer-events: none;
        }

        .reader-toolbar {
            height: auto; min-height: 80px;
            padding: 0.75rem 1rem;
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
            color: #fcd34d;
            flex-shrink: 0;
        }

        .reader-tools { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; flex: 1; }
        .tool-group { display: flex; align-items: center; gap: 5px; padding-right: 10px; margin-right: 10px; border-right: 1px solid rgba(40, 26, 22, 0.5); flex-wrap: wrap; }
        .tool-group:last-child { border: none; }
        
        .pdf-search-wrapper {
            display: flex; align-items: center; gap: 5px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #281a16;
            border-radius: 4px;
            padding: 0 5px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .pdf-search-input {
            border: none; background: transparent; padding: 6px;
            font-family: 'Georgia', serif; color: #3E2723; width: 120px; font-size: 0.9rem; outline: none;
        }
        .pdf-search-input::placeholder { color: #8D6E63; font-style: italic; font-size: 0.8rem; }

        .tool-btn {
            background: #5d4037; border: 2px solid #281a16; color: #fcd34d;
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;
            font-family: 'Georgia', serif; font-weight: bold;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center; min-width: 40px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .tool-btn:hover { background: #6d4c41; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.5); border-color: #fcd34d; }
        .tool-btn.active { background: #fcd34d; color: #3E2723; border-color: #fff; box-shadow: 0 0 10px rgba(252, 211, 93, 0.6); text-shadow: none; }
        
        .tool-btn.action-btn {
            background: #281a16; color: #fcd34d; border-color: #5d4037;
            font-size: 0.8rem; padding: 6px 10px;
        }
        .tool-btn.action-btn:hover { background: #3e2723; border-color: #fcd34d; }

        .tool-settings { display: none; align-items: center; gap: 10px; padding: 5px 10px; background: rgba(40, 26, 22, 0.4); border-radius: 4px; border: 1px solid #5d4037; }
        .tool-settings.show { display: flex; }
        input[type="color"] { width: 30px; height: 30px; border: 1px solid #fff; padding: 0; background: none; cursor: pointer; border-radius: 3px;}
        input[type="range"] { width: 80px; accent-color: #fcd34d; cursor: pointer; }

        .close-reader-btn {
            background: #b71c1c; border: 2px solid #5d4037; color: white; font-weight: bold;
            padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;
            font-family: 'Georgia', serif;
            box-shadow: 0 3px 5px rgba(0,0,0,0.4);
        }
        .close-reader-btn:hover { background: #c62828; transform: scale(1.05); }

        .reader-desk {
            flex: 1;
            position: relative;
            background-color: #1a1a1a;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            padding: 20px;
            background: radial-gradient(circle, #2d1b15, #1a0f0a);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.9);
            min-height: 0;
        }

        .reader-desk.mode-draw { cursor: crosshair; }

        .paper-sheet {
            position: relative;
            background: white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            width: 100%;
            max-width: 900px;
            height: 5000px; 
            transform-origin: center center;
            transition: transform 0.2s ease;
            border: 1px solid #ccc;
            flex-shrink: 0; 
        }

        .paper-texture {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
            pointer-events: none; z-index: 5; opacity: 0.4; mix-blend-mode: multiply;
        }

        #pdf-iframe {
            width: 100%; height: 100%; border: none;
            position: absolute; top: 0; left: 0; z-index: 1;
            background: white;
            overflow: hidden !important; 
            pointer-events: auto; 
        }

        #drawing-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            pointer-events: none; 
        }
        
        .reader-desk.mode-draw #drawing-layer { pointer-events: auto; }
        .reader-desk.mode-draw #pdf-iframe { pointer-events: none; }


        .reader-footer-panel {
            height: 70px; 
            background: linear-gradient(to bottom, #451a03, #78350f, #451a03);
            border-top: 4px solid #5d4037;
            display: flex; flex-direction: column; padding: 0 20px; color: white; flex-shrink: 0; z-index: 20;
            box-shadow: 0 -10px 20px rgba(0,0,0,0.8);
            transition: height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), padding 0.4s ease;
            overflow: hidden;
            position: relative;
        }
        
        .reader-footer-panel.expanded {
            height: calc(100vh - 85px); 
            padding: 20px;
        }

        .reader-footer-header {
            height: 70px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: absolute;
            top: 0; left: 0;
            z-index: 30;
            background: linear-gradient(to bottom, #4e342e, #3e2723);
            border-bottom: 1px solid #5d4037;
        }

        .reader-footer-header:hover { background: linear-gradient(to bottom, #5d4037, #4e342e); }

        .reader-footer-content {
            margin-top: 70px; 
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease 0.1s;
            pointer-events: none; 
        }

        .reader-footer-panel.expanded .reader-footer-content {
            opacity: 1;
            pointer-events: auto;
        }

        .reader-textarea {
            flex: 1; background: #1a1a1a; border: 2px solid #fcd34d; color: #fcd34d;
            padding: 15px; border-radius: 4px; font-family: 'Georgia', serif; font-size: 1.2rem; resize: none; margin-bottom: 15px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        .reader-textarea:focus { outline: none; box-shadow: 0 0 0 2px rgba(252, 211, 77, 0.5); }
        .reader-textarea::placeholder { color: rgba(252, 211, 77, 0.4); }

        .reader-footer-actions { display: flex; gap: 10px; justify-content: space-between; flex-wrap: wrap; align-items: center; }
        
        .footer-action-btn {
            background: #4e342e; color: #fcd34d; border: 2px solid #281a16; padding: 10px 20px; border-radius: 4px; cursor: pointer;
            font-size: 1rem; display: flex; align-items: center; gap: 8px; transition: all 0.2s; font-family: 'Georgia', serif; font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
        }
        .footer-action-btn:hover { background: #5d4037; border-color: #fcd34d; transform: translateY(-2px); }
        
        .btn-speak { background: #2e7d32; color: white; border-color: #1b5e20; } .btn-speak:hover { background: #388e3c; }

        .tts-selector {
            background: #fff; color: #333; border: 1px solid #ccc; padding: 5px; border-radius: 4px; font-family: sans-serif;
            font-size: 0.9rem;
        }

        .dict-lang-modal {
            display: none;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 350px; max-width: 90%;
            background: #451a03; 
            background-image: repeating-linear-gradient(90deg, rgba(0,0,0,0.05), rgba(0,0,0,0.05) 2px, transparent 4px);
            border: 4px solid #281a16;
            border-radius: 8px; padding: 20px; z-index: 4000;
            box-shadow: 0 15px 40px rgba(0,0,0,0.9);
            color: #fcd34d;
        }
        .dict-lang-modal.active { display: block; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .dict-lang-header { text-align: center; margin-bottom: 15px; font-weight: bold; font-size: 1.3rem; border-bottom: 1px solid #5d4037; padding-bottom: 10px; text-shadow: 1px 1px 2px black;}

        .dict-lang-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 300px; overflow-y: auto; padding-right: 5px; }
        .dict-lang-grid::-webkit-scrollbar { width: 8px; }
        .dict-lang-grid::-webkit-scrollbar-thumb { background: #5d4037; border-radius: 4px; }

        .dict-lang-btn {
            background: #5d4037; border: 2px solid #8d6e63; color: white; padding: 10px;
            border-radius: 6px; cursor: pointer; font-family: 'Georgia', serif; font-size: 0.95rem;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .dict-lang-btn:hover { background: #6d4c41; transform: scale(1.03); border-color: #fcd34d; }
        .dict-cancel { width: 100%; margin-top: 15px; background: #c62828; border-color: #b71c1c; }
        .dict-cancel:hover { background: #d32f2f; }
        
        .dict-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3999;
        }
        .dict-overlay.active { display: block; }

        @keyframes popIn { from { transform: translate(-50%, -40%) scale(0.9); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #451a03; color: #fcd34d; border: 2px solid #fcd34d; padding: 12px 25px; border-radius: 25px;
            font-size: 1rem; z-index: 5000; pointer-events: none; opacity: 0; transition: opacity 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-family: 'Georgia', serif; font-weight: bold;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        .hidden { display: none !important; }
    </style>
</head>
<body class="mode-library">

    <!-- Header Unificado -->
    <header>
        <div class="header-content">
            <div class="nav-bar-wood">
                <button onclick="app.navigate('library')" id="nav-library" class="nav-btn-wood active"><i>üìö</i> Biblioteca</button>
                <button onclick="app.navigate('social')" id="nav-social" class="nav-btn-wood"><i>üçÉ</i> Red Social</button>
                <button onclick="app.navigate('p2p')" id="nav-p2p" class="nav-btn-wood"><i>üîí</i> Chat P2P</button>
            </div>

            <div class="header-title-area" id="library-header-ui">
                <div class="center-wrapper">
                    <h1>LibelulApp - Ultimate Wood</h1>
                    <div class="search-with-stars">
                        <svg class="search-star" viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 69,55 80,90 50,75 20,90 31,55 2,40 39,40" fill="gold" stroke="#B8860B" stroke-width="2" /></svg>
                        <input type="text" id="searchInput" class="search-input" placeholder="Buscar libro o video...">
                        <svg class="search-star" viewBox="0 0 100 100"><polygon points="50,5 61,40 98,40 69,55 80,90 50,75 20,90 31,55 2,40 39,40" fill="red" stroke="#7F1D1D" stroke-width="2" /></svg>
                    </div>
                </div>
               
                <!-- Guardianes decorativos -->
                <div class="guardians-container" style="position: absolute; left: 10px; bottom: -20px;">
                    <img class="guardian-shisa" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRMOuhV-r33EeG4zUxRL3zGHfM4dSlG4YDrTg&s" alt="Shisa Izquierda" />
                    <img class="guardian-statue" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTxJHUlDF4_7mwDAtfC5hLyENEtVIXyFE4FDg&s" alt="Maneki Neko" />
                </div>
                <div class="guardians-container" style="position: absolute; right: 10px; bottom: -20px;">
                    <img class="guardian-statue" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR8AyBlti_G6jkGC1lKWl3dNU1aqPrQyryoxg&s" alt="Kitsune" />
                    <img class="guardian-shisa" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQyPcpMaQW_90WDRnqapKezhV8HAMJsOnbZPA&s" alt="Shisa Derecha" />
                </div>
            </div>
        </div>
    </header>

    <!-- SECCI√ìN 1: BIBLIOTECA -->
    <section id="section-library" class="app-section active">
        <main class="library-mode">
            <div class="library-frame">
                <div class="library-inner">
                    <div class="library-molding top"></div>
                    <div id="bookshelvesContainer"></div>
                    <div class="library-molding bottom"></div>
                </div>
            </div>
        </main>
        <footer>
            <p>üìö LibelulApp - Tu puerta al conocimiento universal üìö</p>
            <small>¬© <span id="currentYear"></span> Todos los derechos reservados</small>
        </footer>
    </section>

    <!-- SECCI√ìN 2: RED SOCIAL -->
    <section id="section-social" class="app-section">
        <div class="app-layout">
            <aside class="sidebar">
                <div class="sidebar-header"><h2>üå± ArbolApp</h2></div>
                <div class="sidebar-tabs">
                    <button onclick="socialManager.switchTab('editor')" class="tab-btn active">‚úèÔ∏è Escribir</button>
                    <button onclick="socialManager.switchTab('data')" class="tab-btn">üíæ Datos</button>
                </div>
                <div id="tab-editor" class="sidebar-content">
                    <div class="form-group"><label>T√≠tulo</label><input type="text" id="post-title" placeholder="Ej: Un nuevo d√≠a"></div>
                    <div class="form-group"><label>Contenido</label><textarea id="post-content" rows="4" placeholder="Escribe aqu√≠..."></textarea></div>
                    <div class="form-group"><label>Archivo (en /media/)</label><input type="text" id="post-media" placeholder="ej: imagen.jpg"></div>
                    <div class="form-group"><label>Tipo</label>
                        <select id="post-type">
                            <option value="image">Imagen</option>
                            <option value="video">Video</option>
                            <option value="audio">Audio</option>
                            <option value="document">PDF</option>
                            <option value="none">Solo Texto</option>
                        </select>
                    </div>
                    <button onclick="socialManager.publish()" class="btn-action">üå± Publicar</button>
                </div>
                <div id="tab-data" class="sidebar-content hidden">
                    <h3 style="color:var(--leaf-light); border-bottom:1px solid #5d4037; padding-bottom:5px;">üì¶ Sincronizaci√≥n</h3>
                    <p style="font-size:0.85rem; color:#cfd8dc; margin-bottom:15px;">Tus posts se guardan localmente. Exporta el JSON para hacerlos permanentes.</p>
                    <button onclick="socialManager.exportPosts()" class="btn-action">‚¨áÔ∏è Descargar posts.json</button>
                    <button onclick="socialManager.clearLocal()" class="btn-secondary" style="margin-top:10px;">üóëÔ∏è Borrar local</button>
                </div>
            </aside>
            <main class="main-feed">
                <div class="tree-trunk">
                    <header class="feed-header">
                        <h1>üå≥ Muro Social</h1>
                    </header>
                    <nav class="nav-branches">
                        <button onclick="socialManager.loadFeed('my')" class="nav-btn active">Mis Hojas</button>
                        <button onclick="socialManager.loadFeed('external')" class="nav-btn">Ramas RSS</button>
                    </nav>
                    <div id="feed-container"></div>
                </div>
            </main>
        </div>
    </section>

    <!-- SECCI√ìN 3: CHAT P2P -->
    <section id="section-p2p" class="app-section">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--wood-dark); color: white;">
            <h1 style="margin-bottom: 20px;">üîí Chat P2P Cifrado</h1>
            <div class="p2p-box" style="max-width: 500px; width: 90%; background:var(--wood-light); padding:20px; border-radius:10px; border:2px solid var(--leaf-green); color:white;">
                <div style="text-align:center; margin-bottom:15px;">
                    <div id="p2p-status-icon" class="phone-icon phone-grey" style="font-size:3rem;">üì±</div>
                    <div id="p2p-status-text" style="margin-top:5px; font-weight:bold;">Desconectado</div>
                </div>
                <div class="p2p-log" id="p2p-log" style="background:#000; color:#0f0; padding:10px; height:60px; overflow-y:auto; margin-bottom:10px; font-family:monospace; font-size:0.8rem;">Sistema iniciado...</div>
                <div style="margin-bottom:10px;">
                    <label style="font-size:0.8rem; color:#aaa;">Tu ID:</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="my-peer-id-display" readonly style="flex:1; background:#222; border:1px solid #555; color:#fff; padding:5px; font-family:monospace;">
                        <button onclick="p2pManager.copyId()" style="cursor:pointer; padding:5px 10px;">üìã</button>
                    </div>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-size:0.8rem; color:#aaa;">Conectar con ID:</label>
                    <input type="text" id="remote-id" placeholder="Pega el ID aqu√≠..." style="width:100%; padding:8px; margin-top:5px;">
                </div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button onclick="p2pManager.connect()" class="btn-action" style="flex:1; background:#2196F3;">üìû Conectar</button>
                </div>
                <div class="chat-window" id="p2p-chat" style="background:#000; color:#fff; height:200px; overflow-y:auto; padding:10px; margin-bottom:10px; border:1px solid #555;"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="p2p-msg" placeholder="Mensaje secreto..." disabled style="flex:1; padding:10px;">
                    <button onclick="p2pManager.send()" id="btn-send-msg" disabled style="padding:10px 20px; background:var(--flower-pink); color:white; border:none; border-radius:5px; cursor:pointer;">‚û§</button>
                </div>
            </div>
        </div>
    </section>

    <!-- MODAL LECTOR MATERIAL -->
    <div id="reader-modal" class="reader-modal">
        <div class="reader-toolbar wood-panel">
            <div class="reader-tools">
                <div class="tool-group">
                    <button id="tool-hand" class="tool-btn active" title="Mano" onclick="readerManager.setTool('hand')">‚úã</button>
                    <button id="tool-pencil" class="tool-btn" title="L√°piz" onclick="readerManager.setTool('pencil')">‚úèÔ∏è</button>
                    <button id="tool-highlighter" class="tool-btn" title="Resaltador" onclick="readerManager.setTool('highlighter')">üñçÔ∏è</button>
                    <button id="tool-eraser" class="tool-btn" title="Borrador" onclick="readerManager.setTool('eraser')">üßπ</button>
                </div>
                
                <div id="tool-settings" class="tool-settings">
                    <input type="color" id="tool-color" value="#000000" title="Color">
                    <input type="range" id="tool-size" min="1" max="20" value="2" title="Grosor">
                </div>

                <div class="tool-group">
                    <button class="tool-btn" onclick="readerManager.toggleGoogleViewer()" title="Forzar Carga (Google)" id="btn-google-view">üîÑ</button>
                    <button class="tool-btn" onclick="readerManager.adjustZoom(0.1)" title="Acercar">‚ûï</button>
                    <button class="tool-btn" onclick="readerManager.adjustZoom(-0.1)" title="Alejar">‚ûñ</button>
                    <button class="tool-btn" onclick="readerManager.resetZoom()" title="Restablecer">‚ü≤</button>
                </div>

                <div class="tool-group" style="margin-left: auto;">
                    
                    <div class="pdf-search-wrapper">
                        <input type="text" id="pdf-search-input" class="pdf-search-input" placeholder="Buscar en texto...">
                        <button class="tool-btn action-btn" onclick="readerManager.searchInPdf()" title="Buscar y Resaltar">üîç</button>
                    </div>

                    <button class="tool-btn action-btn" onclick="readerManager.processClipboardAction('wikipedia')" title="Wikipedia (Ctrl+C)">Wikipedia</button>
                    <button class="tool-btn action-btn" onclick="readerManager.processClipboardAction('dict')" title="Diccionario (Ctrl+C)">üìö</button>
                    <button class="tool-btn action-btn" onclick="readerManager.processClipboardAction('translate')" title="Traducir (Ctrl+C)">üåê</button>
                    
                    <button class="tool-btn action-btn" onclick="readerManager.downloadOriginalPDF()" title="Descargar PDF Original">üì• PDF</button>
                </div>
            </div>
            <button id="closeReader" class="close-reader-btn">Cerrar</button>
        </div>

        <div class="reader-desk" id="readerDesk">
            <div class="paper-sheet" id="paperContainer">
                <div class="paper-texture"></div>
                <iframe id="pdf-iframe" src=""></iframe>
                <canvas id="drawing-layer"></canvas>
            </div>
        </div>

        <div class="reader-footer-panel wood-panel" id="readerFooter">
            <div class="reader-footer-header" onclick="readerManager.toggleFooter()">
                <span style="font-family:'Georgia', serif; font-size:1.1rem; color:#fcd34d; font-weight:bold;">
                    üó£Ô∏è LECTOR DE VOZ (Click para expandir/ocultar)
                </span>
            </div>
            <div class="reader-footer-content">
                <textarea id="reader-notes" class="reader-textarea" placeholder="Pega aqu√≠ el texto que seleccionaste del PDF para leerlo..."></textarea>
                <div class="reader-footer-actions">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <label for="tts-lang" style="color:#fcd34d; font-size:0.9rem;">Voz:</label>
                        <select id="tts-lang" class="tts-selector">
                            <option value="es">Espa√±ol</option>
                            <option value="en">English</option>
                            <option value="it">Italiano</option>
                            <option value="fr">Fran√ßais</option>
                            <option value="de">Deutsch</option>
                            <option value="pt">Portugu√™s</option>
                            <option value="ja">Êó•Êú¨Ë™û</option>
                            <option value="zh">‰∏≠Êñá</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="footer-action-btn btn-speak" onclick="readerManager.speakNotes()"><span>üîä</span> Leer Texto</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="dictOverlay" class="dict-overlay" onclick="readerManager.closeDictionaryModal()"></div>
    <div id="dictModal" class="dict-lang-modal">
        <div class="dict-lang-header">Elegir Diccionario</div>
        <div class="dict-lang-grid">
            <button class="dict-lang-btn" onclick="readerManager.searchDict('es')">üá™üá∏ RAE (Espa√±ol)</button>
            <button class="dict-lang-btn" onclick="readerManager.searchDict('en')">üá∫üá∏ Merriam-Webster (Eng)</button>
            <button class="dict-lang-btn" onclick="readerManager.searchDict('jp')">üáØüáµ Jisho (Japon√©s)</button>
            <button class="dict-lang-btn" onclick="readerManager.searchDict('zh')">üá®üá≥ MDBG (Chino)</button>
            <button class="dict-lang-btn" onclick="readerManager.searchDict('it')">üáÆüáπ Treccani (Italiano)</button>
            <button class="dict-lang-btn" onclick="readerManager.searchDict('de')">üá©üá™ Duden (Alem√°n)</button>
            <button class="dict-lang-btn" onclick="readerManager.searchDict('fr')">üá´üá∑ Larousse (Franc√©s)</button>
            <button class="dict-lang-btn" onclick="readerManager.searchDict('pt')">üáßüá∑ Dicio (Portugu√©s)</button>
            <button class="dict-lang-btn" onclick="readerManager.searchDict('ru')">üá∑üá∫ Gramota (Ruso)</button>
            <button class="dict-lang-btn" onclick="readerManager.searchDict('la')">üèõÔ∏è Latin (LatinDict)</button>
        </div>
        <button class="dict-lang-btn dict-cancel" onclick="readerManager.closeDictionaryModal()">Cancelar</button>
    </div>

    <div id="toast" class="toast">Mensaje</div>

    <div id="tricolorCat" class="cat-container facing-right" style="display:none;">
        <svg class="cat-svg" viewBox="0 0 200 150" xmlns="http://www.w3.org/2000/svg">
            <path class="cat-tail" d="M30,90 Q5,70 15,50" fill="none" />
            <ellipse class="cat-body" cx="100" cy="100" rx="60" ry="35" />
            <path class="patch-black" d="M60,75 Q80,65 110,75 Q120,85 100,125 Q70,130 60,100 Z" opacity="0.9" />
            <circle class="cat-head" cx="150" cy="60" r="35" />
            <path class="patch-orange" d="M125,40 Q150,20 175,45 Q180,60 160,65 Q130,60 125,40 Z" />
            <path class="patch-black" d="M140,30 Q150,15 160,30 Q155,40 145,35 Z" opacity="0.8" />
            <path class="patch-black" d="M115,45 Q110,60 125,70" fill="none" stroke="#2c3e50" stroke-width="4" stroke-linecap="round" opacity="0.8" />
            <path d="M120,40 L110,10 L140,30 Z" fill="#e67e22" stroke="#d35400" stroke-width="2" stroke-linejoin="round"/>
            <path d="M160,40 L175,10 L150,30 Z" fill="#fffbf0" stroke="#ccc" stroke-width="2" stroke-linejoin="round"/>
            <g transform="translate(135, 60)">
                <circle r="5" class="cat-eye" />
                <circle cy="1" r="2" class="cat-pupil" />
                <path d="M-6,0 Q0,5 6,0 L6,8 L-6,8 Z" class="eyelid" />
            </g>
            <g transform="translate(165, 60)">
                <circle r="5" class="cat-eye" />
                <circle cy="1" r="2" class="cat-pupil" />
                <path d="M-6,0 Q0,5 6,0 L6,8 L-6,8 Z" class="eyelid" />
            </g>
            <path d="M148,72 L152,72 L150,78 Z" class="cat-nose" />
            <path d="M150,78 Q145,85 140,78 M150,78 Q155,85 160,78" fill="none" stroke="#2c3e50" stroke-width="2" stroke-linecap="round"/>
            <g stroke="#2c3e50" stroke-width="1" fill="none">
                <path d="M140,75 L120,70" />
                <path d="M140,80 L120,80" />
                <path d="M160,75 L180,70" />
                <path d="M160,80 L180,80" />
            </g>
            <ellipse id="frontPaw" class="cat-paw" cx="130" cy="125" rx="12" ry="8" />
            <ellipse class="cat-paw" cx="150" cy="125" rx="12" ry="8" />
        </svg>
    </div>

    <div id="tricolorCat2" class="cat-container small-cat facing-right" style="display:none;">
        <svg class="cat-svg" viewBox="0 0 200 150" xmlns="http://www.w3.org/2000/svg">
            <path class="cat-tail" d="M30,90 Q5,70 15,50" fill="none" />
            <ellipse class="cat-body" cx="100" cy="100" rx="60" ry="35" />
            <path class="patch-black" d="M60,75 Q80,65 110,75 Q120,85 100,125 Q70,130 60,100 Z" opacity="0.9" />
            <circle class="cat-head" cx="150" cy="60" r="35" />
            <path class="patch-orange" d="M125,40 Q150,20 175,45 Q180,60 160,65 Q130,60 125,40 Z" />
            <path class="patch-black" d="M140,30 Q150,15 160,30 Q155,40 145,35 Z" opacity="0.8" />
            <path class="patch-black" d="M115,45 Q110,60 125,70" fill="none" stroke="#2c3e50" stroke-width="4" stroke-linecap="round" opacity="0.8" />
            <path d="M120,40 L110,10 L140,30 Z" fill="#e67e22" stroke="#d35400" stroke-width="2" stroke-linejoin="round"/>
            <path d="M160,40 L175,10 L150,30 Z" fill="#fffbf0" stroke="#ccc" stroke-width="2" stroke-linejoin="round"/>
            <g transform="translate(135, 60)">
                <circle r="5" class="cat-eye" />
                <circle cy="1" r="2" class="cat-pupil" />
                <path d="M-6,0 Q0,5 6,0 L6,8 L-6,8 Z" class="eyelid" />
            </g>
            <g transform="translate(165, 60)">
                <circle r="5" class="cat-eye" />
                <circle cy="1" r="2" class="cat-pupil" />
                <path d="M-6,0 Q0,5 6,0 L6,8 L-6,8 Z" class="eyelid" />
            </g>
            <path d="M148,72 L152,72 L150,78 Z" fill="black" />
            <path d="M150,78 Q145,85 140,78 M150,78 Q155,85 160,78" fill="none" stroke="#2c3e50" stroke-width="2" stroke-linecap="round"/>
            <g stroke="#2c3e50" stroke-width="1" fill="none">
                <path d="M140,75 L120,70" />
                <path d="M140,80 L120,80" />
                <path d="M160,75 L180,70" />
                <path d="M160,80 L180,80" />
            </g>
            <ellipse id="frontPaw2" class="cat-paw" cx="130" cy="125" rx="12" ry="8" />
            <ellipse class="cat-paw" cx="150" cy="125" rx="12" ry="8" />
        </svg>
    </div>

    <!-- JAVASCRIPT PRINCIPAL -->
    <script>
        // ===========================================
        // 1. DATOS DE LIBROS (REDUCIDO)
        // ===========================================
        const books = [
            { id: 270, title: 'Sutra del Diamante', author: 'Siddhartha Gautama', year: -400, status: 'available', color: '#9acd32', pdfUrl: 'https://www.lastelladelmattino.org/wp-content/uploads/2010/04/El-diamante_parte-budista-completa_F.pdf' },
            { id: 271, title: 'Sutra del Coraz√≥n', author: 'Thich Nhat Hanh', year: 1998, status: 'available', color: '#ba55d3', pdfUrl: 'https://www.platform7x7.com/n/wp-content/uploads/2023/08/EL-SUTRA-DEL-CORAZON-OSHO.pdf' },
            { id: 4, title: 'El mundo como voluntad y representaci√≥n', author: 'Arthur Schopenhauer', year: 1818, status: 'available', color: '#D2691E', pdfUrl: 'https://apiperiodico.jalisco.gob.mx/api/sites/periodicooficial.jalisco.gob.mx/files/el_mundo_como_voluntad_y_representacion-arthur_schopenhauer.pdf' },
            { id: 6, title: 'Matem√°ticas B√°sicas', author: 'Varios Autores', year: 2005, status: 'available', color: '#556B2F', pdfUrl: 'https://www.utadeo.edu.co/sites/tadeo/files/node/publication/field_attached_file/pdf-_matematicas_basicas-_completo-_09-15.pdf' },
            { id: 12, title: 'La Rep√∫blica', author: 'Plat√≥n', year: -375, status: 'available', color: '#5F9EA0', pdfUrl: 'http://bibliotecadigital.econ.uba.ar/download/Pe/180266.pdf' },
            { id: 13, title: 'Po√©tica', author: 'Arist√≥teles', year: -335, status: 'available', color: '#6495ED', pdfUrl: 'https://www.argentina.gob.ar/sites/default/files/poetica_aristoteles.pdf' },
            { id: 36, title: 'Manifiesto Comunista', author: 'Karl Marx, Federico Engels', year: 2015, status: 'available', color: '#D2691E', pdfUrl: 'https://marxismocritico.com/wp-content/uploads/2013/11/127255.pdf' },
            { id: 98, title: 'Cien A√±os de Soledad', author: 'Gabriel Garc√≠a M√°rquez', year: 1967, status: 'available', color: '#8B4513', pdfUrl: 'https://www.secst.cl/upfiles/documentos/19072016_1207am_578dc39115fe9.pdf' },
            { id: 99, title: 'Don Quijote', author: 'Miguel de Cervantes', year: 1605, status: 'available', color: '#A0522D', pdfUrl: 'https://www.suneo.mx/literatura/subidas/Miguel%20de%20Cervantes%20El%20Ingenioso%20Hidalgo%20Don%20Quijote%20de%20la%20Mancha.pdf' },
            { id: 101, title: '1984', author: 'George Orwell', year: 1949, status: 'available', color: '#B8860B', pdfUrl: 'https://www.philosophia.cl/biblioteca/orwell/1984.pdf' },
            { id: 109, title: 'Fahrenheit 451', author: 'Ray Bradbury', year: 1953, status: 'available', color: '#556B2F', pdfUrl: 'https://lexiconic.net/english/F451.pdf' },
            { id: 112, title: 'Fundaci√≥n', author: 'Isaac Asimov', year: 1951, status: 'available', color: '#C71585', pdfUrl: 'https://www.mercaba.org/SANLUIS/ALiteratura/Literatura%20contempor%C3%A1nea/Asimov,%20Issac/Fundaci%C3%B3n.PDF' },
            { id: 116, title: 'EL Nombre de la Rosa', author: 'Umberto Eco', year: 1980, status: 'available', color: '#556B2F', pdfUrl: 'https://www.suneo.mx/literatura/subidas/Umberto%20Eco%20El%20Nombre%20de%20la%20Rosa.pdf' },
            { id: 144, title: 'El camarada', author: 'Takiji Kobayashi', year: 1932, status: 'available', color: '#D2691E', pdfUrl: 'https://elsudamericano.wordpress.com/wp-content/uploads/2019/06/161.el-camarada-takiji-kobayashi.pdf' },
            { id: 183, title: 'El arte de la guerra', author: 'Sun Tzu', year: 1000, status: 'available', color: '#D2691E', pdfUrl: 'https://web.seducoahuila.gob.mx/biblioweb/upload/El_arte_de_la_guerra-Sun_Tzu.pdf' },
            { id: 213, title: 'Meditaciones', author: 'Marco Aurelio', year: 180, status: 'available', color: '#D2691E', pdfUrl: 'https://www.humanidades.unam.mx/bibliotheca/bsgrm$pensamientos$dura$1edicion$TIT_102.pdf' },
            { id: 250, title: 'El pasado de Palestina en disputa', author: 'Pfoh, Emanuel', year: 2016, status: 'available', color: '#D2691E', pdfUrl: 'https://www.memoria.fahce.unlp.edu.ar/art_revistas/pr.13647/pr.13647.pdf' },
            { id: 253, title: 'Clarice Lispector: Cuentos Reunidos', author: 'Clarice Lispector', year: 2021, status: 'available', color: '#D2691E', pdfUrl: 'https://www.amsafe.org.ar/wp-content/uploads/Cuentos_reunidos.pdf' },
            { id: 255, title: 'Shakespeare: Obra Completa', author: '', year: 2017, status: 'available', color: '#D2691E', pdfUrl: 'https://www.colegioemaus.edu.ar/assets/tragedias_shakespeare.pdf' },
            { id: 269, title: 'Alicia a trav√©s del espejo', author: 'Lewis Carrol', year: 1880, status: 'available', color: '#D2691E', pdfUrl: 'https://www.argentina.gob.ar/sites/default/files/a_traves_del_espejo_y_lo_que_alicia_encontro_al_otro_lado-lewis_carroll_revisado.pdf' }
        ];

        // ===========================================
        // APP MANAGER (NAVEGACI√ìN)
        // ===========================================
        const app = {
            navigate: (section) => {
                document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-btn-wood').forEach(el => el.classList.remove('active'));
               
                document.getElementById(`section-${section}`).classList.add('active');
                document.getElementById(`nav-${section}`).classList.add('active');

                const body = document.body;
                if (section === 'social' || section === 'p2p') {
                    body.classList.remove('mode-library');
                    body.classList.add('mode-social');
                    document.getElementById('tricolorCat').style.display = 'none';
                    document.getElementById('tricolorCat2').style.display = 'none';
                } else {
                    body.classList.remove('mode-social');
                    body.classList.add('mode-library');
                    document.getElementById('tricolorCat').style.display = 'block';
                    document.getElementById('tricolorCat2').style.display = 'block';
                }
            }
        };

        // ===========================================
        // LIBRARY MANAGER
        // ===========================================
        const libraryManager = {
            data: [],
            filteredBooks: [],
            liveBugs: [],

            init: () => {
                console.log("Cargando libros desde array incrustado...");
                libraryManager.data = [...books];
                libraryManager.filteredBooks = [...books];
                libraryManager.render();
                libraryManager.initCats();

                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const term = e.target.value.toLowerCase();
                        libraryManager.filteredBooks = libraryManager.data.filter(b =>
                            (b.title && b.title.toLowerCase().includes(term)) ||
                            (b.author && b.author.toLowerCase().includes(term))
                        );
                        libraryManager.render();
                    });
                }
            },

            render: () => {
                const container = document.getElementById('bookshelvesContainer');
                if (!container) return;
                container.innerHTML = '';
                libraryManager.liveBugs = [];

                if (libraryManager.filteredBooks.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:3rem;color:#fcd34d;"><h2>No se encontraron libros</h2></div>';
                    return;
                }

                const totalShelves = 20; // Reducido a 20 para ahorrar espacio
                const baseBooksPerShelf = Math.floor(libraryManager.filteredBooks.length / totalShelves);
                const extraBooks = libraryManager.filteredBooks.length % totalShelves;
                
                for (let i = 0; i < totalShelves; i++) {
                    const booksThisShelf = baseBooksPerShelf + (i < extraBooks ? 1 : 0);
                    const startIdx = i * baseBooksPerShelf + Math.min(i, extraBooks);
                    const shelfBooks = libraryManager.filteredBooks.slice(startIdx, startIdx + booksThisShelf);
                    
                    container.appendChild(libraryManager.createBookshelf(shelfBooks, i === 0, i % 2 === 0));
                }
            },

            createBookElement: (book) => {
                const bookDiv = document.createElement('button');
                bookDiv.className = 'book';
                bookDiv.style.backgroundColor = book.color || '#8B4513';
                bookDiv.title = `${book.title} - ${book.author}`;

                bookDiv.onclick = () => {
                    const targetUrl = book.pdfUrl || book.url;
                    if (targetUrl) {
                        readerManager.open(targetUrl);
                    } else {
                        showToast("Este libro no tiene URL disponible");
                    }
                };

                const spine = document.createElement('div'); spine.className = 'book-spine'; bookDiv.appendChild(spine);
                const texture = document.createElement('div'); texture.className = 'book-texture'; bookDiv.appendChild(texture);
                const decoration = document.createElement('div'); decoration.className = 'book-decoration';
                for (let i = 0; i < 3; i++) {
                    const line = document.createElement('div'); line.className = 'book-line'; decoration.appendChild(line);
                }
                bookDiv.appendChild(decoration);

                const label = document.createElement('div'); label.className = 'book-label';
                const labelText = document.createElement('div'); labelText.className = 'book-label-text'; labelText.textContent = book.title.slice(0, 10);
                const labelAuthor = document.createElement('div'); labelAuthor.className = 'book-label-author'; labelAuthor.textContent = book.author.split(' ').pop();
                label.appendChild(labelText); label.appendChild(labelAuthor); bookDiv.appendChild(label);

                if (Math.random() > 0.85) {
                    const bug = libraryManager.createBug('butterfly'); bookDiv.appendChild(bug);
                } else if (Math.random() > 0.7) {
                    const bug = libraryManager.createBug('ladybug'); bookDiv.appendChild(bug);
                }
                return bookDiv;
            },

            createSpecialBook: (title, url, color) => {
                const link = document.createElement('a');
                link.href = url; link.target = '_blank'; link.rel = 'noopener noreferrer';
                link.className = 'special-book'; link.style.backgroundColor = color; link.title = title;
                const texture = document.createElement('div'); texture.className = 'special-book-texture'; link.appendChild(texture);
                const decoration = document.createElement('div'); decoration.className = 'special-book-decoration';
                for (let i = 0; i < 5; i++) { const line = document.createElement('div'); line.className = 'special-book-line'; decoration.appendChild(line); }
                link.appendChild(decoration);
                const label = document.createElement('div'); label.className = 'special-book-label'; label.textContent = title; link.appendChild(label);
                if (Math.random() > 0.6) { const bug = libraryManager.createBug(Math.random() > 0.8 ? 'butterfly' : 'ladybug'); link.appendChild(bug); }
                return link;
            },

            createBug: (type) => {
                const bug = document.createElement('div');
                if (type === 'butterfly') {
                    const randColor = Math.random();
                    let colorClass = ''; if (randColor > 0.66) colorClass = 'blue'; else if (randColor > 0.33) colorClass = 'yellow';
                    bug.className = `butterfly ${colorClass}`;
                    bug.innerHTML = '<div class="butterfly-wing left"></div><div class="butterfly-wing right"></div>';
                } else if (type === 'ladybug') {
                    bug.className = 'ladybug-container';
                    bug.innerHTML = `<div class="ladybug-wing-under left"></div><div class="ladybug-wing-under right"></div><div class="ladybug-head"></div><div class="ladybug-shell left"><div class="ladybug-spot-shell ls-1"></div><div class="ladybug-spot-shell ls-2"></div></div><div class="ladybug-shell right"><div class="ladybug-spot-shell ls-3"></div><div class="ladybug-spot-shell ls-4"></div></div>`;
                }
                libraryManager.liveBugs.push(bug);
                return bug;
            },

            createWalkingLadybug: () => {
                const container = document.createElement('div');
                container.className = 'ladybug-walking';
                container.innerHTML = `<div class="spot lw-s1"></div><div class="spot lw-s2"></div><div class="spot lw-s3"></div><div class="spot lw-s4"></div><div class="ladybug-walking-legs"></div>`;
                const direction = Math.random() > 0.5 ? 1 : -1; 
                const startX = direction === 1 ? -10 : 110; const endX = direction === 1 ? 110 : -10;
                const duration = 10000 + Math.random() * 5000; 
                container.style.left = startX + '%'; container.style.bottom = '5px'; container.style.transform = `scaleX(${direction})`;
                libraryManager.liveBugs.push(container);
                container.animate([ { left: startX + '%' }, { left: endX + '%' } ], { duration: duration, iterations: Infinity, easing: 'linear' });
                return container;
            },

            createBookshelf: (books, isFirstShelf, alignLeft) => {
                const shelfDiv = document.createElement('div'); shelfDiv.className = 'bookshelf';
                const shelfBg = document.createElement('div'); shelfBg.className = 'bookshelf-bg';
                const booksContainer = document.createElement('div'); booksContainer.className = 'books-container';
                if (alignLeft) booksContainer.classList.add('align-left'); else booksContainer.classList.add('align-right');

                if (isFirstShelf) {
                    booksContainer.appendChild(libraryManager.createSpecialBook('NihongoApp', 'https://kami00dragon.github.io/NihongoApp/index.html', '#8B0000'));
                    booksContainer.appendChild(libraryManager.createSpecialBook('AeternusApp', 'https://kami00dragon.github.io/AeternusApp/', '#5D4037'));
                    booksContainer.appendChild(libraryManager.createSpecialBook('GramaticApp', 'https://kami00dragon.github.io/gramaticapp/#posturas-teoricas', '#424242'));
                }

                books.forEach(book => booksContainer.appendChild(libraryManager.createBookElement(book)));

                const shelfBoard = document.createElement('div'); shelfBoard.className = 'shelf-board';
                shelfBg.appendChild(booksContainer); shelfBg.appendChild(shelfBoard); shelfDiv.appendChild(shelfBg);

                if (Math.random() > 0.7) shelfBg.appendChild(libraryManager.createWalkingLadybug());
                return shelfDiv;
            },

            initCats: () => {
                if (typeof TricolorCat === 'undefined') return;
                setTimeout(() => {
                    const cat1El = document.getElementById('tricolorCat');
                    const cat2El = document.getElementById('tricolorCat2');
                    let cat1 = null, cat2 = null;
                    
                    if(cat1El) { cat1 = new TricolorCat('tricolorCat'); cat1.start(); }
                    if(cat2El) { cat2 = new TricolorCat('tricolorCat2'); setTimeout(() => cat2.start(), 2000); }

                    if(cat1El || cat2El) {
                        setInterval(() => {
                            const c1Rect = cat1El ? cat1El.getBoundingClientRect() : {right:0, left:0, x:0, y:0};
                            const c2Rect = cat2El ? cat2El.getBoundingClientRect() : {right:0, left:0, x:0, y:0};
                            const cats = [];
                            if(cat1El) cats.push({ rect: c1Rect, instance: cat1 });
                            if(cat2El) cats.push({ rect: c2Rect, instance: cat2 });

                            cats.forEach(catObj => {
                                if (catObj.rect.right > 0 && catObj.rect.left < window.innerWidth) {
                                    libraryManager.liveBugs.forEach(bug => {
                                        if (!bug.getBoundingClientRect) return;
                                        const bugRect = bug.getBoundingClientRect();
                                        const dist = Math.hypot(catObj.rect.x - bugRect.x, catObj.rect.y - bugRect.y);
                                        if (dist < 150) catObj.instance.tryTouchBug();
                                    });
                                }
                            });
                        }, 500);
                    }
                }, 1000);
            }
        };

        // ===========================================
        // CLASES DE ANIMACIONES (GATO Y ZORRO)
        // ===========================================
        class BabyFox {
            constructor() {
                this.container = document.createElement('div'); this.container.className = 'baby-fox';
                this.container.innerHTML = `<svg viewBox="0 0 200 150" xmlns="http://www.w3.org/2000/svg"><path d="M40,100 Q-10,70 10,40 Q20,20 40,30 Q50,40 45,60 Z" fill="#E65100" /><path d="M10,40 Q20,20 40,30 Q30,25 20,35 Z" fill="#FFF3E0" /><ellipse cx="110" cy="110" rx="40" ry="35" fill="#E65100" /><ellipse cx="110" cy="120" rx="20" ry="12" fill="#FFF3E0" /><circle cx="150" cy="80" r="35" fill="#E65100" /><path d="M135,95 Q150,105 165,95 Q160,110 150,110 Q140,110 135,95" fill="#FFF3E0" /><path d="M130,60 L115,25 L145,50 Z" fill="#E65100" /><path d="M170,60 L185,25 L155,50 Z" fill="#E65100" /><path d="M130,55 L120,35 L142,52 Z" fill="#FFF3E0" /><path d="M170,55 L180,35 L158,52 Z" fill="#FFF3E0" /><path d="M140,75 Q145,80 150,75" fill="none" stroke="#3E2723" stroke-width="2" /><path d="M150,75 Q155,80 160,75" fill="none" stroke="#3E2723" stroke-width="2" /><circle cx="150" cy="90" r="4" fill="#3E2723" /></svg>`;
                document.body.appendChild(this.container); this.width = 130; this.isBusy = false;
            }
            start() { this.scheduleNextAction(); }
            scheduleNextAction() { setTimeout(() => { if (!this.isBusy) this.decideAction(); }, 5000 + Math.random() * 10000); }
            decideAction() { if (Math.random() < 0.7) this.peek(); else this.runSolo(); }
            peek() {
                this.isBusy = true; const side = Math.random() > 0.5 ? 'right' : 'left'; this.container.style.transition = 'none';
                if (side === 'left') { this.container.style.transform = 'scaleX(1)'; this.container.style.left = '-130px'; } else { this.container.style.transform = 'scaleX(-1)'; this.container.style.left = '100vw'; }
                this.container.style.bottom = '3rem'; void this.container.offsetWidth; this.container.style.transition = 'left 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                if (side === 'left') this.container.style.left = '0px'; else this.container.style.left = 'calc(100vw - 130px)';
                setTimeout(() => this.hidePeek(side), 1500);
            }
            hidePeek(side) {
                this.container.style.transition = 'left 0.5s ease-in';
                if (side === 'left') this.container.style.left = '-150px'; else this.container.style.left = '100vw';
                setTimeout(() => { this.isBusy = false; this.scheduleNextAction(); }, 500);
            }
            runSolo() {
                this.isBusy = true; const direction = Math.random() > 0.5 ? 'LtoR' : 'RtoL';
                this.container.style.transition = 'none';
                if (direction === 'LtoR') { this.container.style.transform = 'scaleX(1)'; this.container.style.left = '-250px'; } else { this.container.style.transform = 'scaleX(-1)'; this.container.style.left = '100vw'; }
                this.container.style.bottom = '3rem'; void this.container.offsetWidth; this.container.style.transition = `left 3500ms linear`;
                if (direction === 'LtoR') this.container.style.left = '100vw'; else this.container.style.left = '-250px';
                setTimeout(() => { this.isBusy = false; this.scheduleNextAction(); }, 3500);
            }
        }

        class TricolorCat {
            constructor(elementId) {
                this.container = document.getElementById(elementId);
                if (!this.container) return;
                this.pawGroup = this.container.querySelector('.cat-paw');
                this.width = parseInt(getComputedStyle(this.container).width) || 150;
                this.isRunning = false;
                const react = () => { this.hideCompletely(); clearTimeout(this.timer); clearTimeout(this.peekTimer); this.scheduleNextAction(); };
                this.container.addEventListener('click', react);
            }
            start() { this.scheduleNextAction(); }
            scheduleNextAction() { this.timer = setTimeout(() => this.decideAction(), 2000 + Math.random() * 3000); }
            decideAction() {
                this.container.classList.remove('is-running-anim'); if (this.pawGroup) this.pawGroup.classList.remove('swiping');
                const rand = Math.random();
                if (rand < 0.10) this.initiateChase(); else if (rand < 0.6) this.runOnShelves(); else this.peek();
            }
            initiateChase() {
                if (!window.foxInstance) window.foxInstance = new BabyFox();
                const direction = Math.random() > 0.5 ? 'LtoR' : 'RtoL';
                window.foxInstance.runAction(direction, 3, null);
                setTimeout(() => this.runOnShelves(direction, 3), 400);
            }
            runOnShelves(direction = null, bottomPos = null) {
                this.isRunning = true;
                if (!direction) direction = Math.random() > 0.5 ? 'LtoR' : 'RtoL';
                this.container.style.transition = 'none';
                if (direction === 'LtoR') { this.container.style.transform = 'scaleX(1)'; this.container.style.left = '-200px'; } 
                else { this.container.style.transform = 'scaleX(-1)'; this.container.style.left = (window.innerWidth + 200) + 'px'; }
                this.container.style.bottom = `${bottomPos || 2}rem`; void this.container.offsetWidth;
                this.container.classList.add('is-running-anim'); this.container.style.transition = `left 3500ms linear`;
                if (direction === 'LtoR') this.container.style.left = '100vw'; else this.container.style.left = '-200px';
                setTimeout(() => { this.isRunning = false; this.container.classList.remove('is-running-anim'); this.hideCompletely(); this.scheduleNextAction(); }, 3500);
            }
            peek() {
                this.isRunning = false; const side = Math.random() > 0.5 ? 'right' : 'left'; this.container.style.transition = 'none';
                if (side === 'left') { this.container.style.left = `-${this.width}px`; } else { this.container.style.right = `-${this.width}px`; this.container.style.left = 'auto'; }
                this.container.style.bottom = `2rem`; void this.container.offsetHeight; this.container.style.transition = 'left 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), right 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                if (side === 'left') this.container.style.left = `0px`; else this.container.style.right = `0px`;
                this.peekTimer = setTimeout(() => { this.hideCompletely(); this.scheduleNextAction(); }, 1500 + Math.random() * 2000);
            }
            hideCompletely() {
                clearTimeout(this.peekTimer); this.container.style.transition = 'all 0.3s ease-in';
                if (this.container.style.right !== 'auto') { this.container.style.right = `-${this.width + 50}px`; setTimeout(() => { this.container.style.left = 'auto'; }, 300); }
                else { this.container.style.left = `-${this.width + 50}px`; setTimeout(() => { this.container.style.right = 'auto'; }, 300); }
            }
            tryTouchBug() { if (this.pawGroup) { this.pawGroup.classList.remove('swiping'); void this.pawGroup.offsetWidth; this.pawGroup.classList.add('swiping'); } }
        }

        // ===========================================
        // READER MANAGER (ULTIMATE WOOD COMPLETO)
        // ===========================================
        const readerManager = {
            state: { tool: 'hand', isDrawing: false, lastX: 0, lastY: 0, color: '#000000', size: 2, zoom: 1, isGoogleView: false },
            currentPdfUrl: '',
            currentDictWord: '',

            open: (url) => {
                readerManager.currentPdfUrl = url;
                const modal = document.getElementById('reader-modal');
                const pdfIframe = document.getElementById('pdf-iframe');
                const canvas = document.getElementById('drawing-layer');
                const ctx = canvas.getContext('2d');
                const paperContainer = document.getElementById('paperContainer');
                const readerDesk = document.getElementById('readerDesk');
                const settingsPanel = document.getElementById('tool-settings');
                const btnGoogleView = document.getElementById('btn-google-view');
                const readerFooter = document.getElementById('readerFooter');

                modal.classList.add('active');
                pdfIframe.src = url; 
                readerManager.state.isGoogleView = false;
                btnGoogleView.classList.remove('active');
                readerManager.setTool('hand');
                readerManager.resetZoom();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                setTimeout(readerManager.resizeCanvas, 1000);
                
                readerFooter.classList.remove('expanded');
                document.getElementById('reader-notes').value = '';
                document.getElementById('pdf-search-input').value = '';
            },

            toggleGoogleViewer: () => {
                if(!readerManager.currentPdfUrl) return;
                const pdfIframe = document.getElementById('pdf-iframe');
                const btnGoogleView = document.getElementById('btn-google-view');
                
                readerManager.state.isGoogleView = !readerManager.state.isGoogleView;
                if(readerManager.state.isGoogleView) {
                    pdfIframe.src = "https://docs.google.com/gview?embedded=1&url=" + encodeURIComponent(readerManager.currentPdfUrl) + "&scrollbar=0";
                    btnGoogleView.classList.add('active');
                } else {
                    pdfIframe.src = readerManager.currentPdfUrl;
                    btnGoogleView.classList.remove('active');
                }
            },

            close: () => {
                document.getElementById('reader-modal').classList.remove('active');
                document.getElementById('pdf-iframe').src = '';
                readerManager.currentPdfUrl = '';
                const ctx = document.getElementById('drawing-layer').getContext('2d');
                ctx.clearRect(0,0, document.getElementById('drawing-layer').width, document.getElementById('drawing-layer').height);
                window.speechSynthesis.cancel();
            },

            setTool: (toolName) => {
                readerManager.state.tool = toolName;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                if(toolName !== 'hand') document.getElementById(`tool-${toolName}`).classList.add('active');
                else document.getElementById('tool-hand').classList.add('active');
                
                const settingsPanel = document.getElementById('tool-settings');
                const readerDesk = document.getElementById('readerDesk');

                if(toolName === 'pencil' || toolName === 'highlighter') settingsPanel.classList.add('show');
                else settingsPanel.classList.remove('show');

                if(toolName === 'hand') {
                    readerDesk.classList.remove('mode-draw');
                    readerDesk.style.overflowY = 'auto';
                } else {
                    readerDesk.classList.add('mode-draw');
                    readerDesk.style.overflowY = 'hidden'; 
                }
            },

            resizeCanvas: () => {
                const canvas = document.getElementById('drawing-layer');
                const paperContainer = document.getElementById('paperContainer');
                canvas.width = paperContainer.offsetWidth; 
                canvas.height = paperContainer.offsetHeight;
                const ctx = canvas.getContext('2d');
                ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                ctx.lineWidth = readerManager.state.size;
                ctx.strokeStyle = readerManager.state.color;
            },

            getPos: (e) => {
                const canvas = document.getElementById('drawing-layer');
                const paperContainer = document.getElementById('paperContainer');
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
            },

            startDraw: (e) => { if(readerManager.state.tool === 'hand') return; readerManager.state.isDrawing = true; const pos = readerManager.getPos(e); readerManager.state.lastX = pos.x; readerManager.state.lastY = pos.y; },
            draw: (e) => {
                if(!readerManager.state.isDrawing) return;
                const pos = readerManager.getPos(e);
                const canvas = document.getElementById('drawing-layer');
                const ctx = canvas.getContext('2d');
                
                ctx.beginPath(); ctx.moveTo(readerManager.state.lastX, readerManager.state.lastY); ctx.lineTo(pos.x, pos.y);
                ctx.lineWidth = readerManager.state.size;
                if(readerManager.state.tool === 'eraser') {
                    ctx.globalCompositeOperation = 'destination-out'; ctx.strokeStyle = 'rgba(0,0,0,1)'; ctx.lineWidth = readerManager.state.size * 5;
                } else if (readerManager.state.tool === 'highlighter') {
                    ctx.globalCompositeOperation = 'multiply'; ctx.strokeStyle = readerManager.hexToRgba(readerManager.state.color, 0.4); ctx.lineWidth = readerManager.state.size * 6;
                } else {
                    ctx.globalCompositeOperation = 'source-over'; ctx.strokeStyle = readerManager.state.color; ctx.lineWidth = readerManager.state.size;
                }
                ctx.stroke();
                readerManager.state.lastX = pos.x; readerManager.state.lastY = pos.y;
            },
            stopDraw: () => { readerManager.state.isDrawing = false; },

            adjustZoom: (delta) => { 
                readerManager.state.zoom += delta; 
                if(readerManager.state.zoom < 0.5) readerManager.state.zoom = 0.5; 
                if(readerManager.state.zoom > 3) readerManager.state.zoom = 3; 
                document.getElementById('paperContainer').style.transform = `scale(${readerManager.state.zoom})`;
            },
            resetZoom: () => { readerManager.state.zoom = 1; document.getElementById('paperContainer').style.transform = `scale(1)`; },

            toggleFooter: () => {
                const readerFooter = document.getElementById('readerFooter');
                readerFooter.classList.toggle('expanded');
                if (readerFooter.classList.contains('expanded')) { setTimeout(() => document.getElementById('reader-notes').focus(), 100); }
            },

            getClipboardText: async () => {
                try { const text = await navigator.clipboard.readText(); if(text && text.trim().length > 0) return text.trim(); } catch (err) { console.warn("API moderna fall√≥...", err); }
                const hiddenInput = document.createElement("textarea"); hiddenInput.style.position = "fixed"; hiddenInput.style.left = "-9999px"; document.body.appendChild(hiddenInput); hiddenInput.focus();
                const successful = document.execCommand('paste'); const text = hiddenInput.value; document.body.removeChild(hiddenInput);
                if (successful && text && text.trim().length > 0) return text.trim();
                showToast("No se pudo acceder al portapapeles.");
                return null;
            },

            processClipboardAction: async (actionType) => {
                const text = await readerManager.getClipboardText(); if (!text) return;
                if (actionType === 'wikipedia') { const url = `https://es.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(text)}`; window.open(url, '_blank'); } 
                else if (actionType === 'dict') { readerManager.currentDictWord = text; document.getElementById('dictOverlay').classList.add('active'); document.getElementById('dictModal').classList.add('active'); } 
                else if (actionType === 'translate') { const url = `https://translate.google.com/?sl=auto&tl=es&text=${encodeURIComponent(text)}`; window.open(url, '_blank'); }
            },

            searchInPdf: () => {
                const term = document.getElementById('pdf-search-input').value.trim(); if (!term) { showToast("Escribe una palabra para buscar"); return; }
                if (!readerManager.state.isGoogleView) { readerManager.toggleGoogleViewer(); }
                const baseUrl = "https://docs.google.com/gview?embedded=1&url=" + encodeURIComponent(readerManager.currentPdfUrl) + "&scrollbar=0";
                document.getElementById('pdf-iframe').src = baseUrl + "#search=" + encodeURIComponent(term);
                showToast("Buscando...");
            },

            downloadOriginalPDF: () => {
                if(!readerManager.currentPdfUrl) { showToast("No hay documento cargado"); return; }
                const link = document.createElement('a'); link.href = readerManager.currentPdfUrl; link.download = "documento.pdf"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            },

            closeDictionaryModal: () => { document.getElementById('dictOverlay').classList.remove('active'); document.getElementById('dictModal').classList.remove('active'); readerManager.currentDictWord = ''; },
            searchDict: (langCode) => {
                const word = readerManager.currentDictWord; if(!word) { showToast("No hay palabra seleccionada."); readerManager.closeDictionaryModal(); return; } 
                let url = ''; switch(langCode) {
                    case 'es': url = `https://dle.rae.es/${word}`; break; case 'en': url = `https://www.merriam-webster.com/dictionary/${word}`; break;
                    case 'jp': url = `https://jisho.org/search/${word}`; break; case 'zh': url = `https://www.mdbg.net/chindict/chindict.php?page=worddict&wdrst=0&wdqb=${encodeURIComponent(word)}`; break;
                    case 'it': url = `https://www.treccani.it/vocabolario/${word.toLowerCase()}/`; break; case 'de': url = `https://www.duden.de/rechtschreibung/${word.toLowerCase()}`; break;
                    case 'fr': url = `https://www.larousse.fr/dictionnaires/francais/${word.toLowerCase()}`; break; case 'pt': url = `https://dicio.com.br/${word.toLowerCase()}/`; break;
                    case 'ru': url = `https://gramota.ru/slovari/dic?bts=${word}`; break; case 'la': url = `https://www.latin-dictionary.net/search/latin/${word}`; break;
                }
                if(url) { window.open(url, '_blank'); readerManager.closeDictionaryModal(); }
            },

            speakNotes: () => {
                const text = document.getElementById('reader-notes').value.trim(); const langCode = document.getElementById('tts-lang').value; if(!text) return;
                window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text);
                const langMap = { 'es': 'es-ES', 'en': 'en-US', 'it': 'it-IT', 'fr': 'fr-FR', 'de': 'de-DE', 'pt': 'pt-BR', 'ja': 'ja-JP', 'zh': 'zh-CN' };
                u.lang = langMap[langCode] || 'es-ES';
                let voices = window.speechSynthesis.getVoices(); const langVoices = voices.filter(v => v.lang.startsWith(langCode)); 
                if (langVoices.length > 0) { u.voice = langVoices[0]; }
                u.rate = 1.0; window.speechSynthesis.speak(u);
            },

            hexToRgba: (hex, alpha) => { const r = parseInt(hex.slice(1,3), 16); const g = parseInt(hex.slice(3,5), 16); const b = parseInt(hex.slice(5,7), 16); return `rgba(${r},${g},${b},${alpha})`; }
        };

        const canvas = document.getElementById('drawing-layer');
        canvas.addEventListener('mousedown', readerManager.startDraw);
        canvas.addEventListener('mousemove', readerManager.draw);
        canvas.addEventListener('mouseup', readerManager.stopDraw);
        canvas.addEventListener('mouseout', readerManager.stopDraw);
        
        canvas.addEventListener('touchstart', e => { const touch=e.touches[0]; const me=new MouseEvent('mousedown',{clientX:touch.clientX,clientY:touch.clientY}); canvas.dispatchEvent(me); e.preventDefault(); }, {passive:false});
        canvas.addEventListener('touchmove', e => { const touch=e.touches[0]; const me=new MouseEvent('mousemove',{clientX:touch.clientX,clientY:touch.clientY}); canvas.dispatchEvent(me); e.preventDefault(); }, {passive:false});
        canvas.addEventListener('touchend', e => { const me=new MouseEvent('mouseup',{}); canvas.dispatchEvent(me); });

        document.getElementById('tool-color').addEventListener('input', (e) => readerManager.state.color = e.target.value);
        document.getElementById('tool-size').addEventListener('input', (e) => readerManager.state.size = parseInt(e.target.value));
        document.getElementById('closeReader').onclick = readerManager.close;


        // ===========================================
        // SOCIAL MANAGER
        // ===========================================
        const socialManager = {
            data: [],
            init: async () => {
                let localPosts = JSON.parse(localStorage.getItem('libelula_social_posts') || '[]');
                socialManager.data = localPosts.sort((a, b) => new Date(b.date) - new Date(a.date));
                socialManager.loadFeed('my');
            },
            switchTab: (tab) => {
                document.querySelectorAll('.sidebar-content').forEach(el => el.classList.add('hidden')); document.getElementById(`tab-${tab}`).classList.remove('hidden');
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); event.target.classList.add('active');
            },
            publish: () => {
                const title = document.getElementById('post-title').value.trim(); const content = document.getElementById('post-content').value.trim();
                if (!title || !content) { showToast("Falta t√≠tulo o contenido"); return; }
                const newPost = { id: Date.now(), date: new Date().toISOString(), title, content };
                socialManager.data.unshift(newPost);
                localStorage.setItem('libelula_social_posts', JSON.stringify(socialManager.data));
                showToast("Hoja publicada"); document.getElementById('post-title').value = ''; document.getElementById('post-content').value = '';
                socialManager.loadFeed('my');
            },
            loadFeed: (type) => {
                const container = document.getElementById('feed-container'); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                if(event && event.target) event.target.classList.add('active'); container.innerHTML = '';
                if (type === 'my') {
                    if (socialManager.data.length === 0) { container.innerHTML = '<div style="text-align:center;padding:2rem;color:#a5d6a7;">No hay posts a√∫n.</div>'; return; }
                    socialManager.data.forEach(post => container.appendChild(socialManager.createPostCard(post, true)));
                } else { container.innerHTML = '<div style="text-align:center;padding:2rem;">Funcionalidad RSS externa deshabilitada en esta demo local.</div>'; }
            },
            createPostCard: (post, isOwn) => {
                const card = document.createElement('article'); card.className = 'leaf-card';
                card.innerHTML = `<div class="post-meta"><span>üìÖ ${new Date(post.date).toLocaleDateString()}</span><span>‚úèÔ∏è Propio</span></div><h2 class="post-title">${post.title}</h2><div class="post-content">${post.content}</div>`;
                return card;
            },
            exportPosts: () => { const blob = new Blob([JSON.stringify(socialManager.data, null, 2)], { type: "application/json" }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "posts.json"; a.click(); showToast("posts.json descargado"); },
            clearLocal: () => { if(confirm("¬øBorrar posts locales?")) { localStorage.removeItem('libelula_social_posts'); socialManager.data = []; socialManager.loadFeed('my'); showToast("Borrado"); } }
        };

        // ===========================================
        // P2P MANAGER
        // ===========================================
        const p2pManager = {
            peer: null, conn: null,
            init: () => {
                p2pManager.peer = new Peer(null, { debug: 2 });
                p2pManager.peer.on('open', (id) => { document.getElementById('my-peer-id-display').value = id; p2pManager.setStatus('idle'); });
                p2pManager.peer.on('connection', (conn) => p2pManager.handleConnection(conn));
                p2pManager.peer.on('error', (err) => { console.log(err); p2pManager.setStatus('idle'); });
            },
            handleConnection: (conn) => {
                p2pManager.conn = conn; conn.on('open', () => { p2pManager.setStatus('connected'); p2pManager.enableChat(true); p2pManager.addSystemMessage("Conectado"); });
                conn.on('data', (data) => p2pManager.addMessage(data, 'received'));
                conn.on('close', () => { p2pManager.setStatus('idle'); p2pManager.enableChat(false); p2pManager.addSystemMessage("Desconectado"); p2pManager.conn = null; });
            },
            connect: () => {
                const destId = document.getElementById('remote-id').value.trim(); if(!destId) return; p2pManager.setStatus('calling');
                const conn = p2pManager.peer.connect(destId, { reliable: true }); p2pManager.handleConnection(conn);
            },
            send: () => {
                const input = document.getElementById('p2p-msg'); const text = input.value.trim(); if(!text || !p2pManager.conn) return;
                p2pManager.conn.send(text); p2pManager.addMessage(text, 'sent'); input.value = '';
            },
            copyId: () => { const id = document.getElementById('my-peer-id-display').value; navigator.clipboard.writeText(id).then(() => showToast("ID copiado")); },
            log: (msg) => { const el = document.getElementById('p2p-log'); el.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`; el.scrollTop = el.scrollHeight; },
            addMessage: (text, type) => { const chat = document.getElementById('p2p-chat'); const div = document.createElement('div'); div.className = `message msg-${type}`; div.innerText = text; chat.appendChild(div); chat.scrollTop = chat.scrollHeight; },
            addSystemMessage: (text) => { const chat = document.getElementById('p2p-chat'); const div = document.createElement('div'); div.style.cssText = "text-align:center;color:#aaa;font-size:0.8rem;margin:10px 0;"; div.innerText = `--- ${text} ---`; chat.appendChild(div); chat.scrollTop = chat.scrollHeight; },
            setStatus: (status) => { const icon = document.getElementById('p2p-status-icon'); const txt = document.getElementById('p2p-status-text'); if(status === 'idle') { icon.className = 'phone-icon phone-grey'; txt.innerText = 'Desconectado'; } else if(status === 'calling') { icon.className = 'phone-icon phone-blue'; txt.innerText = 'Conectando...'; } else if(status === 'connected') { icon.className = 'phone-icon phone-green'; txt.innerText = 'En l√≠nea'; } },
            enableChat: (enabled) => { document.getElementById('p2p-msg').disabled = !enabled; document.getElementById('btn-send-msg').disabled = !enabled; }
        };

        // ===========================================
        // UTILIDADES E INICIO
        // ===========================================
        function showToast(msg) {
            const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentYear').innerText = new Date().getFullYear();
            libraryManager.init();
            socialManager.init();
            p2pManager.init();
            window.speechSynthesis.onvoiceschanged = () => {};

            document.getElementById('p2p-msg').addEventListener('keypress', (e) => { if (e.key === 'Enter') p2pManager.send(); });
            
            document.addEventListener('keydown', e => {
                if(e.key === 'Escape') {
                    if(document.getElementById('reader-modal').classList.contains('active')) readerManager.close();
                }
            });

            window.foxInstance = new BabyFox();
        });
    </script>
</body>
</html>
